<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <title>sethfischer - Python</title>
        <link rel="stylesheet" href="http://seth.fischer.nz/theme/css/main.css" />
        <link href="http://seth.fischer.nz/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="sethfischer Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://seth.fischer.nz/">sethfischer</a></h1>
                <nav><ul>
                    <li><a href="http://seth.fischer.nz/about.html">About</a></li>
                    <li><a href="http://seth.fischer.nz/category/drupal.html">Drupal</a></li>
                    <li><a href="http://seth.fischer.nz/category/misc.html">Misc</a></li>
                    <li><a href="http://seth.fischer.nz/category/symfony.html">Symfony</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://seth.fischer.nz/drupal-8-fabric-deploy.html">Deploying Drupal 8 with Fabric</a></h1>
<footer class="post-info">
        <abbr class="published" title="2015-02-06T09:38:00+13:00">
                Published: 06 February 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://seth.fischer.nz/author/seth-fischer.html">Seth Fischer</a>
        </address>
<p>In <a href="http://seth.fischer.nz/category/drupal.html">Drupal</a>.</p>
<p>tags: <a href="http://seth.fischer.nz/tag/drupal-8.html">Drupal 8</a> <a href="http://seth.fischer.nz/tag/drupal.html">Drupal</a> <a href="http://seth.fischer.nz/tag/fabric.html">Fabric</a> <a href="http://seth.fischer.nz/tag/python.html">Python</a> </p>
</footer><!-- /.post-info --><p>An automated build and deployment process saves time and, more importantly,
provides a safeguard against failed deployments. <a href="http://www.fabfile.org/">Fabric</a> is a tool that can
be used to automate application deployment and related tasks. This article
describes using Fabric to deploy a Drupal&nbsp;8 site.</p>
<p>Visit <a href="https://github.com/sethfischer/fabric-deploy">github.com/sethfischer/fabric-deploy</a> for the most recent version of
the fabfile which is an adaptation of <a href="https://github.com/halcyonCorsair/fabric-deploy">fabric-deploy by halcyonCorsair</a> — a
fabfile for the deployment of Drupal&nbsp;7 sites.</p>
<div class="toc">
<ul>
<li><a href="#drupal-project-structure">Drupal project structure</a><ul>
<li><a href="#synchronise-site-uuid-across-instances">Synchronise site UUID across instances</a></li>
<li><a href="#exclude-files-from-release-tarball">Exclude files from release tarball</a></li>
</ul>
</li>
<li><a href="#target-host-configuration">Target host configuration</a><ul>
<li><a href="#user-account">User account</a></li>
<li><a href="#directory-structure">Directory structure</a></li>
<li><a href="#dependencies">Dependencies</a></li>
<li><a href="#manual-configuration">Manual configuration</a></li>
</ul>
</li>
<li><a href="#fabfile">Fabfile</a><ul>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#available-commands">Available commands</a></li>
<li><a href="#usage">Usage</a></li>
<li><a href="#source-code">Source code</a></li>
</ul>
</li>
<li><a href="#further-reading">Further reading</a></li>
</ul>
</div>
<h2 id="drupal-project-structure">Drupal project structure</h2>
<p>The fabfile is designed to deploy a site having a project structure as
described in <a href="http://seth.fischer.nz/drupal-8-workflow-using-git-subtree-merging.html">A Drupal&nbsp;8 workflow using the Git subtree merge strategy</a>,
but may be easily adapted to accommodate another project structure.</p>
<h3 id="synchronise-site-uuid-across-instances">Synchronise site <abbr title="Universally unique identifier">UUID</abbr> across instances</h3>
<p>So that configuration can be shared between instances of the site (development,
staging, production) they must share a common <abbr title="Universally unique identifier">UUID</abbr>.</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> drush cget system.site
<span class="go">uuid: cdd9a662-e53d-0944-be57-8765c04d38f1</span>
<span class="go">name: example.com</span>
<span class="go">mail: admin@example.com</span>
<span class="go">slogan: &#39;&#39;</span>
<span class="go">page:</span>
<span class="go">  403: &#39;&#39;</span>
<span class="go">  404: &#39;&#39;</span>
<span class="go">  front: node</span>
<span class="go">admin_compact_mode: false</span>
<span class="go">weight_select_max: 100</span>
<span class="go">langcode: en</span>
</code></pre></div>


<p>The site <abbr title="Universally unique identifier">UUID</abbr> may be edited with the command <code>drush cedit system.site</code>. For a
robust approach to synchronising UUIDs across instances of a site see
<a href="http://dcycleproject.org/blog/68/approach-code-driven-development-drupal-8">An approach to code-driven development in Drupal 8</a> by <a href="https://github.com/alberto56/">Albert Albala</a>.</p>
<h3 id="exclude-files-from-release-tarball">Exclude files from release tarball</h3>
<p>As an enhancement files can be excluded from the release tarball by including a
<code>.gitattributes</code> file in the root of the repository and specifying the
<a href="http://git-scm.com/book/en/v2/Customizing-Git-Git-Attributes#Exporting-Your-Repository">export-ignore attribute</a> for files that should not be included in the
release. Use this
<a href="https://gist.github.com/sethfischer/bdda9753837ab1da680a">.gitattributes export-ignore template for Druapl&nbsp;8 projects</a>.</p>
<h2 id="target-host-configuration">Target host configuration</h2>
<h3 id="user-account">User account</h3>
<p>The user who executes the deployment must have ssh access to the target host
and permissions to execute commands as both the <code>root</code> and web server user —
usually <code>www-data</code> on Debian–based systems.</p>
<h3 id="directory-structure">Directory structure</h3>
<p>Variable data such as the Drupal <code>files/</code> directory, <code>settings.php</code>, and
<code>services.yml</code> is located in <code>/var/lib/www/example.com/</code>.</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> tree -AF /var/lib/www/example.com/
<span class="go">/var/lib/www/example.com/</span>
<span class="go">├── files/</span>
<span class="go">├── services.yml</span>
<span class="go">└── settings.php</span>
</code></pre></div>


<p>The Drupal site code base is installed in <code>/var/www/</code> with symlinks to the
variable data being created during deployment.</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> tree -AFL <span class="m">4</span> /var/www/example.com/
<span class="go">/var/www/example.com/</span>
<span class="go">├── current -&gt; /var/www/example.com/releases/tag_x/</span>
<span class="go">└── releases/</span>
<span class="go">    └── tag_x/</span>
<span class="go">        ├── config/</span>
<span class="go">        │   ├── active/</span>
<span class="go">        │   ├── deploy/</span>
<span class="go">        │   └── staging/</span>
<span class="go">        ├── drupal/</span>
<span class="go">        │   ├── composer.json</span>
<span class="go">        │   ├── core/</span>
<span class="go">        │   ├── example.gitignore</span>
<span class="go">        │   ├── index.php</span>
<span class="go">        │   ├── modules/</span>
<span class="go">        │   ├── profiles/</span>
<span class="go">        │   ├── README.txt</span>
<span class="go">        │   ├── robots.txt</span>
<span class="go">        │   ├── sites/</span>
<span class="go">        │   ├── themes/</span>
<span class="go">        │   └── web.config</span>
<span class="go">        └── README.md</span>

<span class="gp">$</span> tree -AFL /var/www/example.com/releases/tag_x/drupal/sites/default/
<span class="go">/var/www/example.com/releases/tag_x/drupal/sites/default/</span>
<span class="go">├── files -&gt; /var/lib/www/uat.reptiles.veri.co.nz/files/</span>
<span class="go">├── services.yml -&gt; /var/lib/www/uat.reptiles.veri.co.nz/services.yml</span>
<span class="go">└── settings.php -&gt; /var/lib/www/uat.reptiles.veri.co.nz/settings.php</span>
</code></pre></div>


<h3 id="dependencies">Dependencies</h3>
<p>The following tools must be installed on the target host:</p>
<ul>
<li><a href="https://wiki.debian.org/SSH">OpenSSH server</a></li>
<li><a href="http://docs.drush.org/en/master/install/#composer-one-drush-for-all-projects">Drush</a></li>
</ul>
<h3 id="manual-configuration">Manual configuration</h3>
<p>The database, <code>settings.php</code> and <code>services.yml</code> must be manually created on the
target host before the first deployment.</p>
<p>Create the database and database user:</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> ssh host
<span class="gp">$</span> mysql -uroot -p
<span class="go">mysql&gt; CREATE DATABASE db;</span>
<span class="go">mysql&gt; CREATE USER &#39;dbuser&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;password&#39;;</span>
<span class="go">mysql&gt; GRANT ALL PRIVILEGES ON db.* TO &#39;dbuser&#39;@&#39;localhost&#39;;</span>
<span class="go">mysql&gt; FLUSH PRIVILEGES;</span>
<span class="go">mysql&gt; \q</span>
</code></pre></div>


<p>Copy <code>sites/default/settings.php</code> and <code>sites/default/services.yml</code>to the target
host and edit as appropriate according to the environment.</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> scp settings.php host:/var/lib/www/example.com/settings.php
<span class="gp">$</span> scp services.yml host:/var/lib/www/example.com/services.yml
</code></pre></div>


<h2 id="fabfile">Fabfile</h2>
<p>Source code is hosted at <a href="https://github.com/sethfischer/fabric-deploy">github.com/sethfischer/fabric-deploy</a>.</p>
<h3 id="configuration">Configuration</h3>
<p>Configuration is expressed via <a href="http://yaml.org/">YAML</a> with one file per project. Below is an
example configuration file.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># example.yml</span>

<span class="c1"># global configuration common to all environments</span>
<span class="nt">_global</span><span class="p">:</span>
    <span class="nt">repository</span><span class="p">:</span>     <span class="l l-Scalar l-Scalar-Plain">ssh+git://github.com/user/repo.git</span>
    <span class="nt">build_dir</span><span class="p">:</span>      <span class="l l-Scalar l-Scalar-Plain">/home/tmp/builds</span>
    <span class="nt">remote_tmp_dir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp</span>

<span class="c1"># staging environment</span>
<span class="nt">staging</span><span class="p">:</span>
    <span class="nt">hosts</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">staging.example.com</span>
    <span class="nt">remote_tmp_dir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp</span>

<span class="c1"># production environment</span>
<span class="nt">prod</span><span class="p">:</span>
    <span class="nt">hosts</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">example.com</span>
</code></pre></div>


<h3 id="available-commands">Available commands</h3>
<p><code>fab -f drupal8 -l</code> will list the available commands with a short description:</p>
<dl>
<dt>deploy</dt>
<dd>Deploy release</dd>
<dt>init_deploy</dt>
<dd>Deploy initial release</dd>
<dt>init_host</dt>
<dd>Initialise directory structure on target host</dd>
<dt>site</dt>
<dd>Load configuration from YAML file</dd>
</dl>
<h3 id="usage">Usage</h3>
<p>Initialise directory structure on the <code>uat</code> host of <code>example.com</code>:</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> fab -f drupal8 site:example.com,uat init_host
</code></pre></div>


<p>Deploy <code>tag_x</code> for <code>example.com</code> to <code>uat</code>:</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> fab -f drupal8 site:example.com,uat deploy:tag_x
</code></pre></div>


<h3 id="source-code">Source code</h3>
<p>For the latest code <code>git clone https://github.com/sethfischer/fabric-deploy</code> or
<a href="https://github.com/sethfischer/fabric-deploy/fork">create a fork</a>.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Fabric deploy for Drupal 8</span>

<span class="sd">https://github.com/sethfischer/fabric-deploy</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">env</span><span class="p">,</span> <span class="n">lcd</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">put</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">runs_once</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">sudo</span><span class="p">,</span> \
    <span class="n">task</span>
<span class="kn">from</span> <span class="nn">fabric.colors</span> <span class="kn">import</span> <span class="n">red</span>
<span class="kn">from</span> <span class="nn">fabric.utils</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">warn</span>
<span class="kn">import</span> <span class="nn">yaml</span>


<span class="nd">@task</span>
<span class="nd">@runs_once</span>
<span class="k">def</span> <span class="nf">site</span><span class="p">(</span><span class="n">site_name</span><span class="p">,</span> <span class="n">tier</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load configuration from YAML file</span>
<span class="sd">    :param site_name: Site name</span>
<span class="sd">    :type site_name: str</span>
<span class="sd">    :param tier: Staging tier</span>
<span class="sd">    :type tier: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span><span class="o">.</span><span class="n">site_name</span> <span class="o">=</span> <span class="n">site_name</span>
    <span class="n">env</span><span class="o">.</span><span class="n">tier</span> <span class="o">=</span> <span class="n">tier</span>

    <span class="n">site_config_filename</span> <span class="o">=</span> <span class="s1">&#39;config/</span><span class="si">{site_name}</span><span class="s1">.yml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">env</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">site_config_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">site_config_filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="s1">&#39;Unable to read </span><span class="si">{site_config_filename}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">site_config_filename</span><span class="o">=</span><span class="n">site_config_filename</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">site_config_data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">site_config_file</span><span class="p">)</span>
        <span class="n">site_config_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">global_config_data</span> <span class="o">=</span> <span class="n">site_config_data</span><span class="p">[</span><span class="s1">&#39;_global&#39;</span><span class="p">]</span>
        <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">global_config_data</span><span class="p">)</span>

        <span class="n">tier_config_data</span> <span class="o">=</span> <span class="n">site_config_data</span><span class="p">[</span><span class="n">tier</span><span class="p">]</span>
        <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tier_config_data</span><span class="p">)</span>

        <span class="n">env</span><span class="o">.</span><span class="n">site_build_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">build_dir</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">site_name</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">site_repo_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_build_dir</span><span class="p">,</span> <span class="s1">&#39;repo&#39;</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">tar_basename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{site_name}</span><span class="s1">.tar&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">env</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">tar_gz_basename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{tar_basename}</span><span class="s1">.gz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">env</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">tar_pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">env</span><span class="o">.</span><span class="n">site_build_dir</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">tar_basename</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">tar_gz_pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">env</span><span class="o">.</span><span class="n">site_build_dir</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">tar_gz_basename</span><span class="p">)</span>


<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">init_host</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Initialise directory structure on target host&quot;&quot;&quot;</span>
    <span class="n">project_dir</span> <span class="o">=</span> <span class="s1">&#39;/var/www/</span><span class="si">{host}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">env</span><span class="p">)</span>
    <span class="n">release_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{project_dir}</span><span class="s1">/releases&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">project_dir</span><span class="o">=</span><span class="n">project_dir</span><span class="p">)</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;/var/lib/www/</span><span class="si">{host}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">env</span><span class="p">)</span>

    <span class="n">sudo</span><span class="p">(</span><span class="s1">&#39;mkdir -p </span><span class="si">{release_dir}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">release_dir</span><span class="o">=</span><span class="n">release_dir</span><span class="p">))</span>
    <span class="n">sudo</span><span class="p">(</span><span class="s1">&#39;chown -R www-data:www-data </span><span class="si">{project_dir}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">project_dir</span><span class="o">=</span><span class="n">project_dir</span><span class="p">))</span>

    <span class="n">sudo</span><span class="p">(</span><span class="s1">&#39;mkdir -p </span><span class="si">{data_dir}</span><span class="s1">/files&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">))</span>
    <span class="n">sudo</span><span class="p">(</span><span class="s1">&#39;chown -R www-data:www-data </span><span class="si">{data_dir}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">))</span>

    <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Database must be manually created.&#39;</span><span class="p">)</span>
    <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{data_dir}</span><span class="s1">/settings.php must be manually created.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">))</span>
    <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{data_dir}</span><span class="s1">/services.yml must be manually created.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">))</span>


<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">init_deploy</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deploy initial release</span>
<span class="sd">    :param tag: Git tags from which to build release</span>
<span class="sd">    :type tag: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">build_exists</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">build</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">upload</span><span class="p">()</span>
    <span class="n">extract</span><span class="p">()</span>
    <span class="n">symlink_settings</span><span class="p">()</span>
    <span class="n">symlink_release</span><span class="p">()</span>
    <span class="n">run_drush</span><span class="p">(</span><span class="s1">&#39;state-set system.maintenance 1&#39;</span><span class="p">)</span>
    <span class="n">run_drush</span><span class="p">(</span><span class="s1">&#39;config-import deploy&#39;</span><span class="p">)</span>
    <span class="n">run_drush</span><span class="p">(</span><span class="s1">&#39;updatedb&#39;</span><span class="p">)</span>
    <span class="n">run_drush</span><span class="p">(</span><span class="s1">&#39;cache-rebuild&#39;</span><span class="p">)</span>
    <span class="n">run_drush</span><span class="p">(</span><span class="s1">&#39;state-set system.maintenance 0&#39;</span><span class="p">)</span>


<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">deploy</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deploy release</span>
<span class="sd">    :param tag: Git tags from which to build release</span>
<span class="sd">    :type tag: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">build_exists</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">build</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">upload</span><span class="p">()</span>
    <span class="n">extract</span><span class="p">()</span>
    <span class="n">run_drush</span><span class="p">(</span><span class="s1">&#39;state-set system.maintenance 1&#39;</span><span class="p">)</span>
    <span class="n">symlink_settings</span><span class="p">()</span>
    <span class="n">symlink_release</span><span class="p">()</span>
    <span class="n">run_drush</span><span class="p">(</span><span class="s1">&#39;config-import deploy&#39;</span><span class="p">)</span>
    <span class="n">run_drush</span><span class="p">(</span><span class="s1">&#39;updatedb&#39;</span><span class="p">)</span>
    <span class="n">run_drush</span><span class="p">(</span><span class="s1">&#39;cache-rebuild&#39;</span><span class="p">)</span>
    <span class="n">run_drush</span><span class="p">(</span><span class="s1">&#39;state-set system.maintenance 0&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">make_dirs</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create directories recursively</span>
<span class="sd">    :param directory: Directory to be created</span>
<span class="sd">    :type directory: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">build_exists</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test if release has previously been deployed</span>
<span class="sd">    :param tag: Git tags from which to build release</span>
<span class="sd">    :type tag: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">project_dir</span> <span class="o">=</span> <span class="s1">&#39;/var/www/</span><span class="si">{host}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">env</span><span class="p">)</span>
    <span class="n">release_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{project_dir}</span><span class="s1">/releases&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">project_dir</span><span class="o">=</span><span class="n">project_dir</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">warn_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s1">&#39;! test -d </span><span class="si">{release_dir}</span><span class="s1">/</span><span class="si">{tag}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">release_dir</span><span class="o">=</span><span class="n">release_dir</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">failed</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="n">red</span><span class="p">(</span><span class="s1">&#39;Release has previously been deployed.&#39;</span><span class="p">))</span>


<span class="nd">@runs_once</span>
<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build release tarball</span>
<span class="sd">    :param tag: Git tags from which to build release</span>
<span class="sd">    :type tag: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span><span class="o">.</span><span class="n">release_tag</span> <span class="o">=</span> <span class="n">tag</span>

    <span class="n">make_dirs</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_repo_dir</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">lcd</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">site_repo_dir</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">warn_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">inside_work_tree</span> <span class="o">=</span> <span class="n">local</span><span class="p">(</span><span class="s1">&#39;git rev-parse --is-inside-work-tree&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inside_work_tree</span><span class="o">.</span><span class="n">failed</span><span class="p">:</span>
            <span class="n">local</span><span class="p">(</span><span class="s1">&#39;git clone </span><span class="si">{repository}</span><span class="s1"> .&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">env</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">local</span><span class="p">(</span><span class="s1">&#39;git pull&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">succeeded</span><span class="p">:</span>
            <span class="n">local</span><span class="p">((</span><span class="s1">&#39;git archive &#39;</span>
                   <span class="s1">&#39;--format=tar &#39;</span>
                   <span class="s1">&#39;--output=</span><span class="si">{tar_pathname}</span><span class="s1"> &#39;</span>
                   <span class="s1">&#39;--prefix=</span><span class="si">{release_tag}</span><span class="s1">/ &#39;</span>
                   <span class="s1">&#39;</span><span class="si">{release_tag}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">env</span><span class="p">))</span>
            <span class="n">local</span><span class="p">(</span><span class="s1">&#39;gzip --force -9 </span><span class="si">{tar_pathname}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">env</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">upload</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Copy tarball to target host&quot;&quot;&quot;</span>
    <span class="n">put</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">tar_gz_pathname</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">remote_tmp_dir</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">extract</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Extract tarball into release directory&quot;&quot;&quot;</span>
    <span class="n">project_dir</span> <span class="o">=</span> <span class="s1">&#39;/var/www/</span><span class="si">{host}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">env</span><span class="p">)</span>
    <span class="n">release_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{project_dir}</span><span class="s1">/releases&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">project_dir</span><span class="o">=</span><span class="n">project_dir</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">sudo_user</span><span class="o">=</span><span class="s1">&#39;www-data&#39;</span><span class="p">):</span>
        <span class="n">tar_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;tar &#39;</span>
                   <span class="s1">&#39;--gzip &#39;</span>
                   <span class="s1">&#39;--extract &#39;</span>
                   <span class="s1">&#39;--verbose &#39;</span>
                   <span class="s1">&#39;--file </span><span class="si">{remote_tmp_dir}</span><span class="s1">/</span><span class="si">{tar_gz_basename}</span><span class="s1"> &#39;</span>
                   <span class="s1">&#39;--directory </span><span class="si">{release_dir}</span><span class="s1">/&#39;</span><span class="p">)</span>
        <span class="n">sudo</span><span class="p">(</span><span class="n">tar_cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">remote_tmp_dir</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">remote_tmp_dir</span><span class="p">,</span>
            <span class="n">tar_gz_basename</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">tar_gz_basename</span><span class="p">,</span>
            <span class="n">release_dir</span><span class="o">=</span><span class="n">release_dir</span><span class="p">))</span>

    <span class="n">run</span><span class="p">(</span><span class="s1">&#39;rm </span><span class="si">{remote_tmp_dir}</span><span class="s1">/</span><span class="si">{tar_gz_basename}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">env</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">symlink_settings</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Symlink configuration files and variable data&quot;&quot;&quot;</span>
    <span class="n">project_dir</span> <span class="o">=</span> <span class="s1">&#39;/var/www/</span><span class="si">{host}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">env</span><span class="p">)</span>
    <span class="n">release_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{project_dir}</span><span class="s1">/releases&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">project_dir</span><span class="o">=</span><span class="n">project_dir</span><span class="p">)</span>
    <span class="n">sites_default</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{release_dir}</span><span class="s1">/</span><span class="si">{release_tag}</span><span class="s1">/drupal/sites/default&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">release_dir</span><span class="o">=</span><span class="n">release_dir</span><span class="p">,</span>
        <span class="n">release_tag</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">release_tag</span><span class="p">)</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;/var/lib/www/</span><span class="si">{host}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">env</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">sudo_user</span><span class="o">=</span><span class="s1">&#39;www-data&#39;</span><span class="p">):</span>
        <span class="n">files_target</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{data_dir}</span><span class="s1">/files&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">)</span>
        <span class="n">files_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{sites_default}</span><span class="s1">/files&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sites_default</span><span class="o">=</span><span class="n">sites_default</span><span class="p">)</span>

        <span class="n">sudo</span><span class="p">(</span><span class="s1">&#39;ln -nfs </span><span class="si">{files_target}</span><span class="s1"> </span><span class="si">{files_dir}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">files_target</span><span class="o">=</span><span class="n">files_target</span><span class="p">,</span>
            <span class="n">files_dir</span><span class="o">=</span><span class="n">files_dir</span><span class="p">))</span>

        <span class="n">settings_target</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{data_dir}</span><span class="s1">/settings.php&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">)</span>
        <span class="n">settings_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{sites_default}</span><span class="s1">/settings.php&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">sites_default</span><span class="o">=</span><span class="n">sites_default</span><span class="p">)</span>

        <span class="n">sudo</span><span class="p">(</span><span class="s1">&#39;ln -nfs </span><span class="si">{settings_target}</span><span class="s1"> </span><span class="si">{settings_file}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">settings_target</span><span class="o">=</span><span class="n">settings_target</span><span class="p">,</span>
            <span class="n">settings_file</span><span class="o">=</span><span class="n">settings_file</span><span class="p">))</span>

        <span class="n">services_target</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{data_dir}</span><span class="s1">/services.yml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">)</span>
        <span class="n">services_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{sites_default}</span><span class="s1">/services.yml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">sites_default</span><span class="o">=</span><span class="n">sites_default</span><span class="p">)</span>

        <span class="n">sudo</span><span class="p">(</span><span class="s1">&#39;ln -nfs </span><span class="si">{services_target}</span><span class="s1"> </span><span class="si">{services_file}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">services_target</span><span class="o">=</span><span class="n">services_target</span><span class="p">,</span>
            <span class="n">services_file</span><span class="o">=</span><span class="n">services_file</span><span class="p">))</span>

    <span class="n">sudo</span><span class="p">(</span><span class="s1">&#39;chown www-data:www-data </span><span class="si">{settings_target}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">settings_target</span><span class="o">=</span><span class="n">settings_target</span><span class="p">))</span>
    <span class="n">sudo</span><span class="p">(</span><span class="s1">&#39;chmod 0400 </span><span class="si">{settings_target}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">settings_target</span><span class="o">=</span><span class="n">settings_target</span><span class="p">))</span>

    <span class="n">sudo</span><span class="p">(</span><span class="s1">&#39;chown www-data:www-data </span><span class="si">{services_target}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">services_target</span><span class="o">=</span><span class="n">services_target</span><span class="p">))</span>
    <span class="n">sudo</span><span class="p">(</span><span class="s1">&#39;chmod 0400 </span><span class="si">{services_target}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">services_target</span><span class="o">=</span><span class="n">services_target</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">symlink_release</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Symlink release&quot;&quot;&quot;</span>
    <span class="n">release_dir</span> <span class="o">=</span> <span class="s1">&#39;/var/www/</span><span class="si">{host}</span><span class="s1">/releases/</span><span class="si">{release_tag}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">env</span><span class="p">)</span>
    <span class="n">current</span> <span class="o">=</span> <span class="s1">&#39;/var/www/</span><span class="si">{host}</span><span class="s1">/current&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">env</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">sudo_user</span><span class="o">=</span><span class="s1">&#39;www-data&#39;</span><span class="p">):</span>
        <span class="n">sudo</span><span class="p">(</span><span class="s1">&#39;ln -nfs </span><span class="si">{release_dir}</span><span class="s1"> </span><span class="si">{current}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">release_dir</span><span class="o">=</span><span class="n">release_dir</span><span class="p">,</span>
            <span class="n">current</span><span class="o">=</span><span class="n">current</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">run_drush</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run a Drush command</span>
<span class="sd">    :param command: Drush command to run</span>
<span class="sd">    :type command: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">sudo_user</span><span class="o">=</span><span class="s1">&#39;www-data&#39;</span><span class="p">):</span>
        <span class="n">sudo</span><span class="p">(</span><span class="s1">&#39;drush -u 1 -y -r </span><span class="si">{drupal_root}</span><span class="s1"> </span><span class="si">{command}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">drupal_root</span><span class="o">=</span><span class="s1">&#39;/var/www/</span><span class="si">{host}</span><span class="s1">/current/drupal&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">env</span><span class="p">),</span>
            <span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">))</span>
</code></pre></div>


<h2 id="further-reading">Further reading</h2>
<ul>
<li><a href="http://www.drushcommands.com/drush-7x/">Drush 7.x commands</a></li>
<li><a href="http://docs.fabfile.org/en/1.10/">Fabric’s documentation</a></li>
<li><a href="https://www.drupal.org/node/1613424">Drupal core issue: Allow a site to be installed from existing configuration</a></li>
<li><a href="https://www.drupal.org/documentation/administer/config">Managing configuration in Drupal 8</a></li>
</ul>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://leaf-obd.readthedocs.io/">Nissan Leaf OBD-II manual</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://seth.fischer.nz/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://github.com/sethfischer">GitHub</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>