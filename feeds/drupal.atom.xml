<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>sethfischer</title><link href="http://seth.fischer.nz/" rel="alternate"></link><link href="http://seth.fischer.nz/feeds/drupal.atom.xml" rel="self"></link><id>http://seth.fischer.nz/</id><updated>2015-07-07T21:19:00+12:00</updated><entry><title>An introduction to Drupal 8 development tools</title><link href="http://seth.fischer.nz/drupal-8-development-tools.html" rel="alternate"></link><updated>2015-07-07T21:19:00+12:00</updated><author><name>Seth Fischer</name></author><id>tag:seth.fischer.nz,2015-07-07:drupal-8-development-tools.html</id><summary type="html">&lt;p&gt;The use of third party components in &lt;a href="https://www.drupal.org/drupal-8.0"&gt;Drupal&amp;nbsp;8&lt;/a&gt; has inspired two new
tools for Drupal&amp;nbsp;8 developers: the Drupal Console and the Drupal Web
Profiler. Based on the &lt;a href="http://symfony.com/doc/current/components/console/introduction.html"&gt;Symfony&amp;nbsp;2 Console&lt;/a&gt; component, the
&lt;a href="http://drupalconsole.com/"&gt;Drupal Console&lt;/a&gt; is a scaffolding generator which allows developers to
reduce development time by automating the generation of boilerplate code. The
&lt;a href="https://www.drupal.org/project/webprofiler"&gt;Drupal Web Profiler&lt;/a&gt; is a port of the
&lt;a href="https://github.com/symfony/WebProfilerBundle"&gt;Symfony&amp;nbsp;2 WebProfiler bundle&lt;/a&gt; as a Drupal&amp;nbsp;8 module providing a
toolbar with convenient access to performance and profile information.&lt;/p&gt;
&lt;div class="toc"&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#drupal-console"&gt;Drupal Console&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href="#commands-in-the-generate-namespace"&gt;Commands in the generate namespace&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href="#example-generating-a-module"&gt;Example: Generating a module&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="#additional-commands"&gt;Additional commands&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#custom-commands"&gt;Custom commands&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#chain-command-execution"&gt;Chain command execution&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="#web-profiler"&gt;Web Profiler&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href="#data-collectors"&gt;Data collectors&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#profiling-decoupled-or-headless-requests"&gt;Profiling decoupled (or headless) requests&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#web-profiler-console-commands"&gt;Web Profiler console commands&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href="#benchmark"&gt;benchmark&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#export"&gt;export&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#list"&gt;list&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="#further-reading"&gt;Further reading&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;h2 id="drupal-console"&gt;Drupal Console&lt;/h2&gt;
&lt;p&gt;The Drupal Console (&lt;a href="https://github.com/hechoendrupal/DrupalConsole"&gt;hechoendrupal/DrupalConsole&lt;/a&gt; on GitHub) is a
&lt;a href="http://symfony.com/doc/current/components/console/introduction.html"&gt;Symfony&amp;nbsp;2 console application&lt;/a&gt; which provides a number of generators
to assist developers in creating boilerplate code. In addition to increasing
productivity Drupal Console is a valuable learning tool which allows developers
to get up and running with best practice code by kick-starting a
&lt;a href="https://www.drupal.org/node/2156625"&gt;PSR-4 compliant directory structure&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Commands are namespaced, the top-level namespaces currently being:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;cache&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;config&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;container&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;generate&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;migrate&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;module&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;rest&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;router&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;site&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;test&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="commands-in-the-generate-namespace"&gt;Commands in the generate namespace&lt;/h3&gt;
&lt;p&gt;Drupal Console currently has thirteen commands in the generate namespace: &lt;/p&gt;
&lt;dl&gt;
&lt;dt&gt;generate:authentication:provider&lt;/dt&gt;
&lt;dd&gt;Generate an authentication provider.&lt;/dd&gt;
&lt;dt&gt;generate:command&lt;/dt&gt;
&lt;dd&gt;Generate commands for the console.&lt;/dd&gt;
&lt;dt&gt;generate:controller&lt;/dt&gt;
&lt;dd&gt;Generate &amp;amp; register a controller.&lt;/dd&gt;
&lt;dt&gt;generate:entity&lt;/dt&gt;
&lt;dd&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;generate:entity:config&lt;/strong&gt; Generate a new "EntityConfig".&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;generate:entity:content&lt;/strong&gt; Generate a new "EntityContent".&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;dt&gt;generate:form:config&lt;/dt&gt;
&lt;dd&gt;Generate a new "ConfigFormBase".&lt;/dd&gt;
&lt;dt&gt;generate:module&lt;/dt&gt;
&lt;dd&gt;Generate a module.&lt;/dd&gt;
&lt;dt&gt;generate:permissions&lt;/dt&gt;
&lt;dd&gt;Generate module permissions.&lt;/dd&gt;
&lt;dt&gt;generate:plugin&lt;/dt&gt;
&lt;dd&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;generate:plugin:block&lt;/strong&gt; Generate a plugin block.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;generate:plugin:imageeffect&lt;/strong&gt; Generate image effect plugin.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;generate:plugin:rest:resource&lt;/strong&gt; Generate plugin rest resource.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;generate:plugin:rulesaction&lt;/strong&gt; Generate a plugin rule action.&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;dt&gt;generate:service&lt;/dt&gt;
&lt;dd&gt;Generate a service.&lt;/dd&gt;
&lt;/dl&gt;
&lt;h4 id="example-generating-a-module"&gt;Example: Generating a module&lt;/h4&gt;
&lt;p&gt;The examples below demonstrate how a module is generated with &lt;code&gt;generate:module&lt;/code&gt;
All other commands follow a similar pattern.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; drupal generate:module

&lt;span class="go"&gt; Welcome to the Drupal module generator&lt;/span&gt;

&lt;span class="go"&gt;Enter the new module name: awesome&lt;/span&gt;
&lt;span class="go"&gt;Enter the module machine name [awesome]: &lt;/span&gt;
&lt;span class="go"&gt;Enter the module Path [/modules/custom]: &lt;/span&gt;
&lt;span class="go"&gt;Enter module description [My Awesome Module]: &lt;/span&gt;
&lt;span class="go"&gt;Enter package name [Other]: &lt;/span&gt;
&lt;span class="go"&gt;Enter Drupal Core version [8.x]: &lt;/span&gt;
&lt;span class="go"&gt;Do you want to generate a default Controller [no]? yes&lt;/span&gt;
&lt;span class="go"&gt;Would you like to add module dependencies [yes]? no&lt;/span&gt;
&lt;span class="go"&gt;Do you want to generate a unit test class [yes]? yes&lt;/span&gt;
&lt;span class="go"&gt;Do you confirm generation [yes]? yes&lt;/span&gt;

&lt;span class="go"&gt; Generated or updated files&lt;/span&gt;

&lt;span class="go"&gt;Site path: /var/www/drupal8&lt;/span&gt;
&lt;span class="go"&gt;1 - /modules/custom/awesome/awesome.info.yml&lt;/span&gt;
&lt;span class="go"&gt;2 - /modules/custom/awesome/awesome.module&lt;/span&gt;
&lt;span class="go"&gt;3 - /modules/custom/awesome/src/Controller/DefaultController.php&lt;/span&gt;
&lt;span class="go"&gt;4 - /modules/custom/awesome/awesome.routing.yml&lt;/span&gt;
&lt;span class="go"&gt;5 - /modules/custom/awesome/Tests/Controller/DefaultControllerTest.php&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Rather than using the default interactive prompt, options can be passed to the
command.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; drupal generate:module &lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="go"&gt;--module=&amp;quot;awesome&amp;quot; \&lt;/span&gt;
&lt;span class="go"&gt;--machine-name=&amp;quot;awesome&amp;quot; \&lt;/span&gt;
&lt;span class="go"&gt;--module-path=&amp;quot;modules/custom&amp;quot; \&lt;/span&gt;
&lt;span class="go"&gt;--description=&amp;quot;My Awesome Module&amp;quot; \&lt;/span&gt;
&lt;span class="go"&gt;--core=&amp;quot;8.x&amp;quot; \&lt;/span&gt;
&lt;span class="go"&gt;--package=&amp;quot;Other&amp;quot; \&lt;/span&gt;
&lt;span class="go"&gt;--controller \&lt;/span&gt;
&lt;span class="go"&gt;--dependencies&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="additional-commands"&gt;Additional commands&lt;/h3&gt;
&lt;p&gt;In addition to commands in the generate namespace Drupal Console has many other
commands. Run &lt;code&gt;drupal list&lt;/code&gt; to list available commands. Modules can define
their own commands so the available commands may vary according to the modules
installed.&lt;/p&gt;
&lt;p&gt;Site status information may be viewed with the command &lt;code&gt;site:status&lt;/code&gt;,
optionally passing the &lt;code&gt;--format=json&lt;/code&gt; option.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; drupal site:status --format&lt;span class="o"&gt;=&lt;/span&gt;json
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Output of above command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;quot;system&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Drupal&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;8.0.0-dev&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Access to update.php&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Protected&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Configuration files&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Protected&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Cron maintenance tasks&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Last run 44 min 45 sec ago&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;D3.js library&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Enabled&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Database system&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;MySQL, MariaDB, Percona Server, or equivalent&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Database system version&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;5.5.43-0+deb7u1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Database updates&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Out of date&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Drupal core update status&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;&amp;lt;a href=\&amp;quot;\/admin\/reports\/updates\&amp;quot;&amp;gt;Unknown release date (version 8.0.0-beta11 available)&amp;lt;\/a&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;File system&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Writable (&amp;lt;em&amp;gt;public&amp;lt;\/em&amp;gt; download method)&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;GD library&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;2.0.36&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;GD library PNG support&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;2.0.36&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Image toolkit&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;gd&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Module and theme update status&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;&amp;lt;a href=\&amp;quot;\/admin\/reports\/updates\&amp;quot;&amp;gt;Out of date&amp;lt;\/a&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Node Access Permissions&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Disabled&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;PHP&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;5.4.41-0+deb7u1 (&amp;lt;a href=\&amp;quot;\/admin\/reports\/status\/php\&amp;quot;&amp;gt;more information&amp;lt;\/a&amp;gt;)&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;PHP extensions&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Enabled&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;PHP memory limit&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;-1 (Unlimited)&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Search index progress&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;100% (0 remaining)&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Trusted Host Settings&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Not enabled&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Unicode library&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;PHP Mbstring Extension&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Update notifications&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Enabled&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Upload progress&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Not enabled&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Web server&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="kc"&gt;null&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;highlight.js library&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Enabled&amp;quot;&lt;/span&gt;
    &lt;span class="p"&gt;},&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;quot;database&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Driver&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;mysql&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Host&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;localhost&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Database connection&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;drupal8&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Port&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Username&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;drupal8&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Password&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;redacted&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Connection&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;mysql\/\/drupal8:redacted@localhost\/drupal8&amp;quot;&lt;/span&gt;
    &lt;span class="p"&gt;},&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;quot;theme&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;theme_default&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;bartik&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;theme_admin&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;seven&amp;quot;&lt;/span&gt;
    &lt;span class="p"&gt;},&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;quot;directory&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Site root directory&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;\/var\/www\/drupal8\/&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Site temporary directory&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;\/tmp&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Default theme directory&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;\/core\/themes\/bartik&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;quot;Admin theme directory&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;\/core\/themes\/seven&amp;quot;&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="custom-commands"&gt;Custom commands&lt;/h3&gt;
&lt;p&gt;Modules may define commands by extending
&lt;code&gt;Symfony\Component\Console\Command\Command&lt;/code&gt;. Drupal Console can create
scaffolding for a custom command with the command &lt;code&gt;generate:command&lt;/code&gt;.
Refer to the &lt;a href="http://symfony.com/doc/current/components/console/introduction.html"&gt;Symfony&amp;nbsp;2 Console Component documentation&lt;/a&gt; for additional
information. For an example implementation refer to the source code of Web
Profiler &lt;code&gt;git clone http://git.drupal.org/project/webprofiler.git&lt;/code&gt;.&lt;/p&gt;
&lt;h3 id="chain-command-execution"&gt;Chain command execution&lt;/h3&gt;
&lt;p&gt;Commands may be recorded in YAML and executed with the &lt;code&gt;chain&lt;/code&gt; command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;drupal chain --file&lt;span class="o"&gt;=&lt;/span&gt;~/d8-project-init.yml
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;In the example below a module will be created, followed by a controller for
that module.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c1"&gt;# d8-project-init.yml&lt;/span&gt;
&lt;span class="l-Scalar-Plain"&gt;commands&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;command&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;generate:module&lt;/span&gt;
      &lt;span class="l-Scalar-Plain"&gt;options&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt;
        &lt;span class="l-Scalar-Plain"&gt;module&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;awesome&lt;/span&gt;
        &lt;span class="l-Scalar-Plain"&gt;machine-name&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;awesome&lt;/span&gt;
        &lt;span class="l-Scalar-Plain"&gt;module-path&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;/modules/custom/&lt;/span&gt;
        &lt;span class="l-Scalar-Plain"&gt;description&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;My Awesome module&lt;/span&gt;
        &lt;span class="l-Scalar-Plain"&gt;core&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;8.x&lt;/span&gt;
        &lt;span class="l-Scalar-Plain"&gt;package&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;Test&lt;/span&gt;
        &lt;span class="l-Scalar-Plain"&gt;controller&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;false&lt;/span&gt;
        &lt;span class="l-Scalar-Plain"&gt;dependencies&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt;
        &lt;span class="l-Scalar-Plain"&gt;test&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;false&lt;/span&gt;
    &lt;span class="p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;command&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;generate:controller&lt;/span&gt;
      &lt;span class="l-Scalar-Plain"&gt;options&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt;
        &lt;span class="l-Scalar-Plain"&gt;module&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;awesome&lt;/span&gt;
        &lt;span class="l-Scalar-Plain"&gt;class-name&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;AwesomeController&lt;/span&gt;
        &lt;span class="l-Scalar-Plain"&gt;method-name&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;index&lt;/span&gt;
        &lt;span class="l-Scalar-Plain"&gt;route&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;/awesome/index&lt;/span&gt;
        &lt;span class="l-Scalar-Plain"&gt;services&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;twig&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="web-profiler"&gt;Web Profiler&lt;/h2&gt;
&lt;p&gt;The &lt;a href="https://www.drupal.org/project/webprofiler"&gt;Drupal Web Profiler&lt;/a&gt; provides convenient access to a selection of
performance and profile information on a per request basis.&lt;/p&gt;
&lt;h3 id="data-collectors"&gt;Data collectors&lt;/h3&gt;
&lt;p&gt;The Web Profiler provides a number of data collectors which include:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;PHP configuration&lt;/li&gt;
&lt;li&gt;route and controller name&lt;/li&gt;
&lt;li&gt;page load timeline and memory use&lt;/li&gt;
&lt;li&gt;front-end statistics (timings for: DNS lookup time; TCP handshake; &lt;abbr title="Time to first byte"&gt;TTFB&lt;/abbr&gt;;
      data download; and  DOM build)&lt;/li&gt;
&lt;li&gt;database query time and number of queries&lt;/li&gt;
&lt;li&gt;authentication details&lt;/li&gt;
&lt;li&gt;number of views&lt;/li&gt;
&lt;li&gt;number of blocks loaded and rendered&lt;/li&gt;
&lt;li&gt;number of modules and themes available&lt;/li&gt;
&lt;li&gt;cache statistics&lt;/li&gt;
&lt;li&gt;asset statistics&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A summary of the data collected is displayed in the Web Profiler toolbar which
is displayed along the lower edge of the viewport.&lt;/p&gt;
&lt;figure&gt;
    &lt;picture&gt;
        &lt;source srcset="/images/drupal-8-webprofiler-toolbar-large.png"
            media="(min-width: 950px)"/&gt;
        &lt;img src="/images/drupal-8-webprofiler-toolbar-medium.png"
            alt="Drupal 8 Web Profiler toolbar"/&gt;
    &lt;/picture&gt;
    &lt;figcaption&gt;The Drupal&amp;nbsp;8 Web Profiler toolbar.&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;Additional detail for each data collector may be viewed by clicking the
relevant icon in the toolbar overlay. Below is the detailed report for the page
load timeline.&lt;/p&gt;
&lt;figure&gt;
    &lt;picture&gt;
        &lt;source srcset="/images/drupal-8-webprofiler-report-large.png"
            media="(min-width: 950px)"/&gt;
        &lt;source srcset="/images/drupal-8-webprofiler-report-medium.png"
            media="(min-width: 600px)"/&gt;
        &lt;img src="/images/drupal-8-webprofiler-report-small.png"
            alt="Drupal 8 Web Profiler toolbar"/&gt;
    &lt;/picture&gt;
    &lt;figcaption&gt;Example of a Drupal&amp;nbsp;8 Web Profiler report timeline.&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;h3 id="profiling-decoupled-or-headless-requests"&gt;Profiling decoupled (or headless) requests&lt;/h3&gt;
&lt;p&gt;The inclusion of a &lt;a href="https://www.drupal.org/developing/api/8/routing"&gt;HTTP routing framework&lt;/a&gt; and &lt;a href="https://www.drupal.org/documentation/modules/rest"&gt;REST API&lt;/a&gt; in
Drupal&amp;nbsp;8 core will make make it significantly easier to develop decoupled
applications using a client-side framework such as &lt;a href="http://emberjs.com/"&gt;ember.js&lt;/a&gt; which
connects to a Drupal backend.&lt;/p&gt;
&lt;p&gt;When profiling an API or headless request the Web Profiler toolbar is not
available. However the profile data remains available for each request via a
token and link provided in the HTTP response headers &lt;code&gt;X-Debug-Token&lt;/code&gt; and
&lt;code&gt;X-Debug-Token-Link&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kr"&gt;HTTP&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="m"&gt;1.1&lt;/span&gt; &lt;span class="m"&gt;200&lt;/span&gt; &lt;span class="ne"&gt;OK&lt;/span&gt;
&lt;span class="na"&gt;Date&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="l"&gt;Fri, 26 Jun 2015 23:53:36 GMT&lt;/span&gt;
&lt;span class="na"&gt;Server&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="l"&gt;Apache/2.2.22 (Debian)&lt;/span&gt;
&lt;span class="na"&gt;X-Generator&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="l"&gt;Drupal 8 (https://www.drupal.org)&lt;/span&gt;
&lt;span class="err"&gt;⋮&lt;/span&gt;
X-Debug-Token: 0ac668
X-Debug-Token-Link: /admin/reports/profiler/view/0ac668
⋮
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Visiting the X-Debug-Token-Link (in this case
&lt;code&gt;/admin/reports/profiler/view/0ac668&lt;/code&gt;) will provide access to the report for
the relevant request.&lt;/p&gt;
&lt;h3 id="web-profiler-console-commands"&gt;Web Profiler console commands&lt;/h3&gt;
&lt;p&gt;Web profiler provides three console commands:&lt;/p&gt;
&lt;dl&gt;
&lt;dt&gt;webprofiler:benchmark&lt;/dt&gt;
&lt;dd&gt;Benchmark a url.&lt;/dd&gt;
&lt;dt&gt;webprofiler:export&lt;/dt&gt;
&lt;dd&gt;Export Webprofiler profile(s) to file.&lt;/dd&gt;
&lt;dt&gt;webprofiler:list&lt;/dt&gt;
&lt;dd&gt;List Webprofiler profiles.&lt;/dd&gt;
&lt;/dl&gt;
&lt;h4 id="benchmark"&gt;benchmark&lt;/h4&gt;
&lt;p&gt;Benchmark a URL.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; drupal webprofiler:benchmark http://drupal8/
&lt;span class="go"&gt; 105/105 [============================] 100% Done.                   &lt;/span&gt;
&lt;span class="go"&gt;date: &amp;#39;Sun, 06/28/2015 - 21:00:43&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;git_commit: &amp;quot;e39a32842072bfbaa2b15c5284625ff63ebc4a08\n&amp;quot;&lt;/span&gt;
&lt;span class="go"&gt;number_of_runs: 100&lt;/span&gt;
&lt;span class="go"&gt;url: &amp;#39;http://drupal8/&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;results:&lt;/span&gt;
&lt;span class="go"&gt;    average: { time: &amp;#39;340 ms&amp;#39;, memory: &amp;#39;38.8 MB&amp;#39; }&lt;/span&gt;
&lt;span class="go"&gt;    median: { time: &amp;#39;336 ms&amp;#39;, memory: &amp;#39;38.8 MB&amp;#39; }&lt;/span&gt;
&lt;span class="go"&gt;    95_percentile: { time: &amp;#39;326 ms&amp;#39;, memory: &amp;#39;38.8 MB&amp;#39; }&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4 id="export"&gt;export&lt;/h4&gt;
&lt;p&gt;Export profile data to a file for later analysis.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; drupal webprofiler:export --directory&lt;span class="o"&gt;=&lt;/span&gt;/tmp/
&lt;span class="go"&gt; 266/266 [============================] 100% Done.                &lt;/span&gt;
&lt;span class="go"&gt;Exported 264 profiles&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4 id="list"&gt;list&lt;/h4&gt;
&lt;p&gt;List and filter profiles.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; drupal webprofiler:list --url&lt;span class="o"&gt;=&lt;/span&gt;http://drupal8/ --method&lt;span class="o"&gt;=&lt;/span&gt;GET --limit&lt;span class="o"&gt;=&lt;/span&gt;5
&lt;span class="go"&gt;+--------+-----------+--------+-----------------+----------------------------+&lt;/span&gt;
&lt;span class="go"&gt;| Token  | IP        | Method | URL             | Time                       |&lt;/span&gt;
&lt;span class="go"&gt;+--------+-----------+--------+-----------------+----------------------------+&lt;/span&gt;
&lt;span class="go"&gt;| 6f6333 | 127.0.0.1 | GET    | http://drupal8/ | Sun, 06/28/2015 - 20:57:01 |&lt;/span&gt;
&lt;span class="go"&gt;| 429e2e | 127.0.0.1 | GET    | http://drupal8/ | Sun, 06/28/2015 - 20:57:00 |&lt;/span&gt;
&lt;span class="go"&gt;| dc1461 | 127.0.0.1 | GET    | http://drupal8/ | Sun, 06/28/2015 - 20:57:00 |&lt;/span&gt;
&lt;span class="go"&gt;| d00a91 | 127.0.0.1 | GET    | http://drupal8/ | Sun, 06/28/2015 - 20:56:59 |&lt;/span&gt;
&lt;span class="go"&gt;| ef359a | 127.0.0.1 | GET    | http://drupal8/ | Sun, 06/28/2015 - 20:56:59 |&lt;/span&gt;
&lt;span class="go"&gt;+--------+-----------+--------+-----------------+----------------------------+&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="further-reading"&gt;Further reading&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.gitbook.com/book/hechoendrupal/drupal-console/details"&gt;The Drupal Console book&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://symfony.com/doc/current/cookbook/profiler/data_collector.html"&gt;How to create a custom data collector&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://drupalize.me/blog/201401/introduction-restful-web-services-drupal-8"&gt;An introduction to RESTful web services in Drupal&amp;nbsp;8&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://pantheon.io/blog/headless-websites-whats-big-deal"&gt;Headless websites: What's the big deal?&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary><category term="Drupal 8"></category><category term="Drupal"></category></entry><entry><title>Deploying Drupal 8 with Fabric</title><link href="http://seth.fischer.nz/drupal-8-fabric-deploy.html" rel="alternate"></link><updated>2015-02-06T09:38:00+13:00</updated><author><name>Seth Fischer</name></author><id>tag:seth.fischer.nz,2015-02-06:drupal-8-fabric-deploy.html</id><summary type="html">&lt;p&gt;An automated build and deployment process saves time and, more importantly,
provides a safeguard against failed deployments. &lt;a href="http://www.fabfile.org/"&gt;Fabric&lt;/a&gt; is a tool that can
be used to automate application deployment and related tasks. This article
describes using Fabric to deploy a Drupal&amp;nbsp;8 site.&lt;/p&gt;
&lt;p&gt;Visit &lt;a href="https://github.com/sethfischer/fabric-deploy"&gt;github.com/sethfischer/fabric-deploy&lt;/a&gt; for the most recent version of
the fabfile which is an adaptation of &lt;a href="https://github.com/halcyonCorsair/fabric-deploy"&gt;fabric-deploy by halcyonCorsair&lt;/a&gt; — a
fabfile for the deployment of Drupal&amp;nbsp;7 sites.&lt;/p&gt;
&lt;div class="toc"&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#drupal-project-structure"&gt;Drupal project structure&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href="#synchronise-site-uuid-across-instances"&gt;Synchronise site UUID across instances&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#exclude-files-from-release-tarball"&gt;Exclude files from release tarball&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="#target-host-configuration"&gt;Target host configuration&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href="#user-account"&gt;User account&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#directory-structure"&gt;Directory structure&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#dependencies"&gt;Dependencies&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#manual-configuration"&gt;Manual configuration&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="#fabfile"&gt;Fabfile&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href="#configuration"&gt;Configuration&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#available-commands"&gt;Available commands&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#usage"&gt;Usage&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#source-code"&gt;Source code&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="#further-reading"&gt;Further reading&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;h2 id="drupal-project-structure"&gt;Drupal project structure&lt;/h2&gt;
&lt;p&gt;The fabfile is designed to deploy a site having a project structure as
described in &lt;a href="http://seth.fischer.nz/drupal-8-workflow-using-git-subtree-merging.html"&gt;A Drupal&amp;nbsp;8 workflow using the Git subtree merge strategy&lt;/a&gt;,
but may be easily adapted to accommodate another project structure.&lt;/p&gt;
&lt;h3 id="synchronise-site-uuid-across-instances"&gt;Synchronise site &lt;abbr title="Universally unique identifier"&gt;UUID&lt;/abbr&gt; across instances&lt;/h3&gt;
&lt;p&gt;So that configuration can be shared between instances of the site (development,
staging, production) they must share a common &lt;abbr title="Universally unique identifier"&gt;UUID&lt;/abbr&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; drush cget system.site
&lt;span class="go"&gt;uuid: cdd9a662-e53d-0944-be57-8765c04d38f1&lt;/span&gt;
&lt;span class="go"&gt;name: example.com&lt;/span&gt;
&lt;span class="go"&gt;mail: admin@example.com&lt;/span&gt;
&lt;span class="go"&gt;slogan: &amp;#39;&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;page:&lt;/span&gt;
&lt;span class="go"&gt;  403: &amp;#39;&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;  404: &amp;#39;&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;  front: node&lt;/span&gt;
&lt;span class="go"&gt;admin_compact_mode: false&lt;/span&gt;
&lt;span class="go"&gt;weight_select_max: 100&lt;/span&gt;
&lt;span class="go"&gt;langcode: en&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The site &lt;abbr title="Universally unique identifier"&gt;UUID&lt;/abbr&gt; may be edited with the command &lt;code&gt;drush cedit system.site&lt;/code&gt;. For a
robust approach to synchronising UUIDs across instances of a site see
&lt;a href="http://dcycleproject.org/blog/68/approach-code-driven-development-drupal-8"&gt;An approach to code-driven development in Drupal 8&lt;/a&gt; by &lt;a href="https://github.com/alberto56/"&gt;Albert Albala&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id="exclude-files-from-release-tarball"&gt;Exclude files from release tarball&lt;/h3&gt;
&lt;p&gt;As an enhancement files can be excluded from the release tarball by including a
&lt;code&gt;.gitattributes&lt;/code&gt; file in the root of the repository and specifying the
&lt;a href="http://git-scm.com/book/en/v2/Customizing-Git-Git-Attributes#Exporting-Your-Repository"&gt;export-ignore attribute&lt;/a&gt; for files that should not be included in the
release. Use this
&lt;a href="https://gist.github.com/sethfischer/bdda9753837ab1da680a"&gt;.gitattributes export-ignore template for Druapl&amp;nbsp;8 projects&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id="target-host-configuration"&gt;Target host configuration&lt;/h2&gt;
&lt;h3 id="user-account"&gt;User account&lt;/h3&gt;
&lt;p&gt;The user who executes the deployment must have ssh access to the target host
and permissions to execute commands as both the &lt;code&gt;root&lt;/code&gt; and web server user —
usually &lt;code&gt;www-data&lt;/code&gt; on Debian–based systems.&lt;/p&gt;
&lt;h3 id="directory-structure"&gt;Directory structure&lt;/h3&gt;
&lt;p&gt;Variable data such as the Drupal &lt;code&gt;files/&lt;/code&gt; directory, &lt;code&gt;settings.php&lt;/code&gt;, and
&lt;code&gt;services.yml&lt;/code&gt; is located in &lt;code&gt;/var/lib/www/example.com/&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; tree -AF /var/lib/www/example.com/
&lt;span class="go"&gt;/var/lib/www/example.com/&lt;/span&gt;
&lt;span class="go"&gt;├── files/&lt;/span&gt;
&lt;span class="go"&gt;├── services.yml&lt;/span&gt;
&lt;span class="go"&gt;└── settings.php&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The Drupal site code base is installed in &lt;code&gt;/var/www/&lt;/code&gt; with symlinks to the
variable data being created during deployment.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; tree -AFL &lt;span class="m"&gt;4&lt;/span&gt; /var/www/example.com/
&lt;span class="go"&gt;/var/www/example.com/&lt;/span&gt;
&lt;span class="go"&gt;├── current -&amp;gt; /var/www/example.com/releases/tag_x/&lt;/span&gt;
&lt;span class="go"&gt;└── releases/&lt;/span&gt;
&lt;span class="go"&gt;    └── tag_x/&lt;/span&gt;
&lt;span class="go"&gt;        ├── config/&lt;/span&gt;
&lt;span class="go"&gt;        │   ├── active/&lt;/span&gt;
&lt;span class="go"&gt;        │   ├── deploy/&lt;/span&gt;
&lt;span class="go"&gt;        │   └── staging/&lt;/span&gt;
&lt;span class="go"&gt;        ├── drupal/&lt;/span&gt;
&lt;span class="go"&gt;        │   ├── composer.json&lt;/span&gt;
&lt;span class="go"&gt;        │   ├── core/&lt;/span&gt;
&lt;span class="go"&gt;        │   ├── example.gitignore&lt;/span&gt;
&lt;span class="go"&gt;        │   ├── index.php&lt;/span&gt;
&lt;span class="go"&gt;        │   ├── modules/&lt;/span&gt;
&lt;span class="go"&gt;        │   ├── profiles/&lt;/span&gt;
&lt;span class="go"&gt;        │   ├── README.txt&lt;/span&gt;
&lt;span class="go"&gt;        │   ├── robots.txt&lt;/span&gt;
&lt;span class="go"&gt;        │   ├── sites/&lt;/span&gt;
&lt;span class="go"&gt;        │   ├── themes/&lt;/span&gt;
&lt;span class="go"&gt;        │   └── web.config&lt;/span&gt;
&lt;span class="go"&gt;        └── README.md&lt;/span&gt;

&lt;span class="gp"&gt;$&lt;/span&gt; tree -AFL /var/www/example.com/releases/tag_x/drupal/sites/default/
&lt;span class="go"&gt;/var/www/example.com/releases/tag_x/drupal/sites/default/&lt;/span&gt;
&lt;span class="go"&gt;├── files -&amp;gt; /var/lib/www/uat.reptiles.veri.co.nz/files/&lt;/span&gt;
&lt;span class="go"&gt;├── services.yml -&amp;gt; /var/lib/www/uat.reptiles.veri.co.nz/services.yml&lt;/span&gt;
&lt;span class="go"&gt;└── settings.php -&amp;gt; /var/lib/www/uat.reptiles.veri.co.nz/settings.php&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="dependencies"&gt;Dependencies&lt;/h3&gt;
&lt;p&gt;The following tools must be installed on the target host:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://wiki.debian.org/SSH"&gt;OpenSSH server&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://docs.drush.org/en/master/install/#composer-one-drush-for-all-projects"&gt;Drush&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="manual-configuration"&gt;Manual configuration&lt;/h3&gt;
&lt;p&gt;The database, &lt;code&gt;settings.php&lt;/code&gt; and &lt;code&gt;services.yml&lt;/code&gt; must be manually created on the
target host before the first deployment.&lt;/p&gt;
&lt;p&gt;Create the database and database user:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; ssh host
&lt;span class="gp"&gt;$&lt;/span&gt; mysql -uroot -p
&lt;span class="go"&gt;mysql&amp;gt; CREATE DATABASE db;&lt;/span&gt;
&lt;span class="go"&gt;mysql&amp;gt; CREATE USER &amp;#39;dbuser&amp;#39;@&amp;#39;localhost&amp;#39; IDENTIFIED BY &amp;#39;password&amp;#39;;&lt;/span&gt;
&lt;span class="go"&gt;mysql&amp;gt; GRANT ALL PRIVILEGES ON db.* TO &amp;#39;dbuser&amp;#39;@&amp;#39;localhost&amp;#39;;&lt;/span&gt;
&lt;span class="go"&gt;mysql&amp;gt; FLUSH PRIVILEGES;&lt;/span&gt;
&lt;span class="go"&gt;mysql&amp;gt; \q&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Copy &lt;code&gt;sites/default/settings.php&lt;/code&gt; and &lt;code&gt;sites/default/services.yml&lt;/code&gt;to the target
host and edit as appropriate according to the environment.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; scp settings.php host:/var/lib/www/example.com/settings.php
&lt;span class="gp"&gt;$&lt;/span&gt; scp services.yml host:/var/lib/www/example.com/services.yml
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="fabfile"&gt;Fabfile&lt;/h2&gt;
&lt;p&gt;Source code is hosted at &lt;a href="https://github.com/sethfischer/fabric-deploy"&gt;github.com/sethfischer/fabric-deploy&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id="configuration"&gt;Configuration&lt;/h3&gt;
&lt;p&gt;Configuration is expressed via &lt;a href="http://yaml.org/"&gt;YAML&lt;/a&gt; with one file per project. Below is an
example configuration file.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c1"&gt;# example.yml&lt;/span&gt;

&lt;span class="c1"&gt;# global configuration common to all environments&lt;/span&gt;
&lt;span class="l-Scalar-Plain"&gt;_global&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l-Scalar-Plain"&gt;repository&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt;     &lt;span class="l-Scalar-Plain"&gt;ssh+git://github.com/user/repo.git&lt;/span&gt;
    &lt;span class="l-Scalar-Plain"&gt;build_dir&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt;      &lt;span class="l-Scalar-Plain"&gt;/home/tmp/builds&lt;/span&gt;
    &lt;span class="l-Scalar-Plain"&gt;remote_tmp_dir&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;/tmp&lt;/span&gt;

&lt;span class="c1"&gt;# staging environment&lt;/span&gt;
&lt;span class="l-Scalar-Plain"&gt;staging&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l-Scalar-Plain"&gt;hosts&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt;
        &lt;span class="p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;staging.example.com&lt;/span&gt;
    &lt;span class="l-Scalar-Plain"&gt;remote_tmp_dir&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;/tmp&lt;/span&gt;

&lt;span class="c1"&gt;# production environment&lt;/span&gt;
&lt;span class="l-Scalar-Plain"&gt;prod&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l-Scalar-Plain"&gt;hosts&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt;
        &lt;span class="p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;example.com&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="available-commands"&gt;Available commands&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;fab -f drupal8 -l&lt;/code&gt; will list the available commands with a short description:&lt;/p&gt;
&lt;dl&gt;
&lt;dt&gt;deploy&lt;/dt&gt;
&lt;dd&gt;Deploy release&lt;/dd&gt;
&lt;dt&gt;init_deploy&lt;/dt&gt;
&lt;dd&gt;Deploy initial release&lt;/dd&gt;
&lt;dt&gt;init_host&lt;/dt&gt;
&lt;dd&gt;Initialise directory structure on target host&lt;/dd&gt;
&lt;dt&gt;site&lt;/dt&gt;
&lt;dd&gt;Load configuration from YAML file&lt;/dd&gt;
&lt;/dl&gt;
&lt;h3 id="usage"&gt;Usage&lt;/h3&gt;
&lt;p&gt;Initialise directory structure on the &lt;code&gt;uat&lt;/code&gt; host of &lt;code&gt;example.com&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; fab -f drupal8 site:example.com,uat init_host
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Deploy &lt;code&gt;tag_x&lt;/code&gt; for &lt;code&gt;example.com&lt;/code&gt; to &lt;code&gt;uat&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; fab -f drupal8 site:example.com,uat deploy:tag_x
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="source-code"&gt;Source code&lt;/h3&gt;
&lt;p&gt;For the latest code &lt;code&gt;git clone https://github.com/sethfischer/fabric-deploy&lt;/code&gt; or
&lt;a href="https://github.com/sethfischer/fabric-deploy/fork"&gt;create a fork&lt;/a&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# -*- coding: utf-8 -*-&lt;/span&gt;
&lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Fabric deploy for Drupal 8&lt;/span&gt;

&lt;span class="sd"&gt;https://github.com/sethfischer/fabric-deploy&lt;/span&gt;
&lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;fabric.api&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;lcd&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;put&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;run&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;runs_once&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;settings&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; \
    &lt;span class="n"&gt;task&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;fabric.colors&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;red&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;fabric.utils&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;abort&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;warn&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;yaml&lt;/span&gt;


&lt;span class="nd"&gt;@task&lt;/span&gt;
&lt;span class="nd"&gt;@runs_once&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;site&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;site_name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;tier&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Load configuration from YAML file&lt;/span&gt;
&lt;span class="sd"&gt;    :param site_name: Site name&lt;/span&gt;
&lt;span class="sd"&gt;    :type site_name: str&lt;/span&gt;
&lt;span class="sd"&gt;    :param tier: Staging tier&lt;/span&gt;
&lt;span class="sd"&gt;    :type tier: str&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;site_name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;site_name&lt;/span&gt;
    &lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tier&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;tier&lt;/span&gt;

    &lt;span class="n"&gt;site_config_filename&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;config/{site_name}.yml&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;site_config_file&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;site_config_filename&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;r&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;IOError&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;abort&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;Unable to read {site_config_filename}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;site_config_filename&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;site_config_filename&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;site_config_data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;yaml&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;safe_load&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;site_config_file&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;site_config_file&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

        &lt;span class="n"&gt;global_config_data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;site_config_data&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;_global&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
        &lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;global_config_data&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="n"&gt;tier_config_data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;site_config_data&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;tier&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
        &lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tier_config_data&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;site_build_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;build_dir&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;site_name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;site_repo_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;site_build_dir&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;repo&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tar_basename&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;{site_name}.tar&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tar_gz_basename&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;{tar_basename}.gz&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tar_pathname&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;site_build_dir&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tar_basename&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tar_gz_pathname&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;site_build_dir&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tar_gz_basename&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;


&lt;span class="nd"&gt;@task&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;init_host&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Initialise directory structure on target host&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;project_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;/var/www/{host}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;release_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;{project_dir}/releases&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;project_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;project_dir&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;data_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;/var/lib/www/{host}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;mkdir -p {release_dir}/&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;release_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;release_dir&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;chown -R www-data:www-data {project_dir}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;project_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;project_dir&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

    &lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;mkdir -p {data_dir}/files&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;data_dir&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;chown -R www-data:www-data {data_dir}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;data_dir&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

    &lt;span class="n"&gt;warn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;Database must be manually created.&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;warn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;{data_dir}/settings.php must be manually created.&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;data_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;data_dir&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;warn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;{data_dir}/services.yml must be manually created.&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;data_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;data_dir&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;


&lt;span class="nd"&gt;@task&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;init_deploy&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tag&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Deploy initial release&lt;/span&gt;
&lt;span class="sd"&gt;    :param tag: Git tags from which to build release&lt;/span&gt;
&lt;span class="sd"&gt;    :type tag: str&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;build_exists&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tag&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;build&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tag&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;upload&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;extract&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;symlink_settings&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;symlink_release&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;run_drush&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;state-set system.maintenance 1&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;run_drush&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;config-import deploy&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;run_drush&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;updatedb&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;run_drush&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;cache-rebuild&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;run_drush&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;state-set system.maintenance 0&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;


&lt;span class="nd"&gt;@task&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;deploy&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tag&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Deploy release&lt;/span&gt;
&lt;span class="sd"&gt;    :param tag: Git tags from which to build release&lt;/span&gt;
&lt;span class="sd"&gt;    :type tag: str&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;build_exists&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tag&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;build&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tag&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;upload&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;extract&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;run_drush&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;state-set system.maintenance 1&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;symlink_settings&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;symlink_release&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;run_drush&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;config-import deploy&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;run_drush&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;updatedb&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;run_drush&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;cache-rebuild&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;run_drush&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;state-set system.maintenance 0&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;make_dirs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;directory&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Create directories recursively&lt;/span&gt;
&lt;span class="sd"&gt;    :param directory: Directory to be created&lt;/span&gt;
&lt;span class="sd"&gt;    :type directory: str&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exists&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;directory&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;makedirs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;directory&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;build_exists&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tag&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Test if release has previously been deployed&lt;/span&gt;
&lt;span class="sd"&gt;    :param tag: Git tags from which to build release&lt;/span&gt;
&lt;span class="sd"&gt;    :type tag: str&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;project_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;/var/www/{host}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;release_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;{project_dir}/releases&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;project_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;project_dir&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="n"&gt;settings&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;warn_only&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;run&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;! test -d {release_dir}/{tag}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;release_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;release_dir&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;tag&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;tag&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;failed&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;abort&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;red&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;Release has previously been deployed.&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;


&lt;span class="nd"&gt;@runs_once&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;build&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tag&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Build release tarball&lt;/span&gt;
&lt;span class="sd"&gt;    :param tag: Git tags from which to build release&lt;/span&gt;
&lt;span class="sd"&gt;    :type tag: str&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;release_tag&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;tag&lt;/span&gt;

    &lt;span class="n"&gt;make_dirs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;site_repo_dir&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="n"&gt;lcd&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;site_repo_dir&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="n"&gt;settings&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;warn_only&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="n"&gt;inside_work_tree&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;git rev-parse --is-inside-work-tree&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;inside_work_tree&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;failed&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;git clone {repository} .&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;git pull&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;succeeded&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;git archive &amp;#39;&lt;/span&gt;
                   &lt;span class="s"&gt;&amp;#39;--format=tar &amp;#39;&lt;/span&gt;
                   &lt;span class="s"&gt;&amp;#39;--output={tar_pathname} &amp;#39;&lt;/span&gt;
                   &lt;span class="s"&gt;&amp;#39;--prefix={release_tag}/ &amp;#39;&lt;/span&gt;
                   &lt;span class="s"&gt;&amp;#39;{release_tag}&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
            &lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;gzip --force -9 {tar_pathname}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;upload&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Copy tarball to target host&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;put&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tar_gz_pathname&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remote_tmp_dir&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;extract&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Extract tarball into release directory&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;project_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;/var/www/{host}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;release_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;{project_dir}/releases&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;project_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;project_dir&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="n"&gt;settings&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sudo_user&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;www-data&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;tar_cmd&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;tar &amp;#39;&lt;/span&gt;
                   &lt;span class="s"&gt;&amp;#39;--gzip &amp;#39;&lt;/span&gt;
                   &lt;span class="s"&gt;&amp;#39;--extract &amp;#39;&lt;/span&gt;
                   &lt;span class="s"&gt;&amp;#39;--verbose &amp;#39;&lt;/span&gt;
                   &lt;span class="s"&gt;&amp;#39;--file {remote_tmp_dir}/{tar_gz_basename} &amp;#39;&lt;/span&gt;
                   &lt;span class="s"&gt;&amp;#39;--directory {release_dir}/&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tar_cmd&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;remote_tmp_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remote_tmp_dir&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;tar_gz_basename&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tar_gz_basename&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;release_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;release_dir&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

    &lt;span class="n"&gt;run&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;rm {remote_tmp_dir}/{tar_gz_basename}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;symlink_settings&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Symlink configuration files and variable data&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;project_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;/var/www/{host}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;release_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;{project_dir}/releases&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;project_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;project_dir&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;sites_default&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;{release_dir}/{release_tag}/drupal/sites/default&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;release_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;release_dir&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="n"&gt;release_tag&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;release_tag&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;data_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;/var/lib/www/{host}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="n"&gt;settings&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sudo_user&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;www-data&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;files_target&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;{data_dir}/files&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;data_dir&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;files_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;{sites_default}/files&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sites_default&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;sites_default&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;ln -nfs {files_target} {files_dir}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;files_target&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;files_target&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;files_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;files_dir&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

        &lt;span class="n"&gt;settings_target&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;{data_dir}/settings.php&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;data_dir&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;settings_file&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;{sites_default}/settings.php&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;sites_default&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;sites_default&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;ln -nfs {settings_target} {settings_file}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;settings_target&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;settings_target&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;settings_file&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;settings_file&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

        &lt;span class="n"&gt;services_target&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;{data_dir}/services.yml&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;data_dir&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;services_file&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;{sites_default}/services.yml&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;sites_default&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;sites_default&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;ln -nfs {services_target} {services_file}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;services_target&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;services_target&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;services_file&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;services_file&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

    &lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;chown www-data:www-data {settings_target}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;settings_target&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;settings_target&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;chmod 0400 {settings_target}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;settings_target&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;settings_target&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

    &lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;chown www-data:www-data {services_target}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;services_target&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;services_target&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;chmod 0400 {services_target}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;services_target&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;services_target&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;symlink_release&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Symlink release&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;release_dir&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;/var/www/{host}/releases/{release_tag}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;current&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;/var/www/{host}/current&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="n"&gt;settings&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sudo_user&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;www-data&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;ln -nfs {release_dir} {current}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;release_dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;release_dir&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="n"&gt;current&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;current&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;run_drush&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;command&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Run a Drush command&lt;/span&gt;
&lt;span class="sd"&gt;    :param command: Drush command to run&lt;/span&gt;
&lt;span class="sd"&gt;    :type command: str&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="n"&gt;settings&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sudo_user&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;www-data&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;sudo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;drush -u 1 -y -r {drupal_root} {command}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;drupal_root&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;/var/www/{host}/current/drupal&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;env&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
            &lt;span class="n"&gt;command&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;command&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="further-reading"&gt;Further reading&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://www.drushcommands.com/drush-7x/"&gt;Drush 7.x commands&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://docs.fabfile.org/en/1.10/"&gt;Fabric’s documentation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.drupal.org/node/1613424"&gt;Drupal core issue: Allow a site to be installed from existing configuration&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.drupal.org/documentation/administer/config"&gt;Managing configuration in Drupal 8&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary><category term="Drupal 8"></category><category term="Drupal"></category><category term="Fabric"></category><category term="Python"></category></entry><entry><title>A Drupal 8 workflow using the Git subtree merge strategy</title><link href="http://seth.fischer.nz/drupal-8-workflow-using-git-subtree-merging.html" rel="alternate"></link><updated>2015-01-23T19:20:00+13:00</updated><author><name>Seth Fischer</name></author><id>tag:seth.fischer.nz,2015-01-23:drupal-8-workflow-using-git-subtree-merging.html</id><summary type="html">&lt;p&gt;Often there are components of a Drupal website that should not be located in
the document root such as configuration files, deployment scripts, and
functional tests. By utilising Git subtrees, a Drupal installation root (or web
server document root) may be below the root of the main repository, and
upstream changes to Drupal core may be conveniently merged with
&lt;code&gt;git read-tree&lt;/code&gt;.&lt;/p&gt;
&lt;div class="toc"&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#initialise-git-repository"&gt;Initialise Git repository&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#add-upstream-remote"&gt;Add upstream remote&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#checkout-a-local-copy-of-the-upstream-branch"&gt;Checkout a local copy of the upstream branch&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#pull-upstream-into-a-subdirectory-in-the-master-branch"&gt;Pull upstream into a subdirectory in the master branch&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#create-a-gitingore-for-drupal-core"&gt;Create a .gitingore for Drupal core&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#create-directories-above-the-document-root"&gt;Create directories above the document root&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#create-the-files-directory-and-set-permissions"&gt;Create the files directory and set permissions&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#create-database"&gt;Create database&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#site-installation"&gt;Site installation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#drupal-configuration-directories"&gt;Drupal configuration directories&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#export-configuration"&gt;Export configuration&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#update-drupal-core"&gt;Update Drupal core&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#further-reading"&gt;Further reading&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;h2 id="initialise-git-repository"&gt;Initialise Git repository&lt;/h2&gt;
&lt;p&gt;Initialise Git repository and add your &lt;code&gt;.gitignore&lt;/code&gt;, &lt;code&gt;README&lt;/code&gt;, and &lt;code&gt;LICENSE&lt;/code&gt;
files.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; mkdir myproject
&lt;span class="gp"&gt;$&lt;/span&gt; &lt;span class="nb"&gt;cd &lt;/span&gt;myproject
&lt;span class="gp"&gt;$&lt;/span&gt; git init
&lt;span class="go"&gt;Initialized empty Git repository in /var/www/myproject/.git/&lt;/span&gt;
&lt;span class="gp"&gt;$&lt;/span&gt; vi README.md
&lt;span class="gp"&gt;$&lt;/span&gt; git add README.md
&lt;span class="gp"&gt;$&lt;/span&gt; git commit -m &lt;span class="s2"&gt;&amp;quot;Add README.md&amp;quot;&lt;/span&gt;
&lt;span class="go"&gt;[master (root-commit) 3a30763] Add README.txt&lt;/span&gt;
&lt;span class="go"&gt; 1 file changed, 1 insertion(+)&lt;/span&gt;
&lt;span class="go"&gt; create mode 100644 README.txt&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="add-upstream-remote"&gt;Add upstream remote&lt;/h2&gt;
&lt;p&gt;Add the drupal.org git repository as a remote with the name &lt;code&gt;upstream&lt;/code&gt;. To
improve efficiency specify that only the &lt;code&gt;8.0.x&lt;/code&gt; branch is to be tracked with
the &lt;code&gt;-t&lt;/code&gt; option.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; git remote add -t 8.0.x upstream http://git.drupal.org/project/drupal.git
&lt;span class="gp"&gt;$&lt;/span&gt; git fetch upstream
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="checkout-a-local-copy-of-the-upstream-branch"&gt;Checkout a local copy of the upstream branch&lt;/h2&gt;
&lt;p&gt;Checkout a local copy of the &lt;code&gt;upstream/8.0.x&lt;/code&gt; branch.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; git checkout -b upstream upstream/8.0.x
&lt;span class="go"&gt;Branch upstream set up to track remote branch 8.0.x from upstream by rebasing.&lt;/span&gt;
&lt;span class="go"&gt;Switched to a new branch &amp;#39;upstream&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="pull-upstream-into-a-subdirectory-in-the-master-branch"&gt;Pull upstream into a subdirectory in the master branch&lt;/h2&gt;
&lt;p&gt;The &lt;code&gt;upstream/8.0.x&lt;/code&gt; branch is pulled in as a subdirectory of the master
branch using the &lt;code&gt;git read-tree&lt;/code&gt; command. The name of the subdirectory is
specified with the &lt;code&gt;--prefix&lt;/code&gt; option; in this case &lt;code&gt;drupal/&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; git checkout master
&lt;span class="gp"&gt;$&lt;/span&gt; git merge -s ours --no-commit upstream/8.0.x
&lt;span class="go"&gt;Automatic merge went well; stopped before committing as requested&lt;/span&gt;
&lt;span class="gp"&gt;$&lt;/span&gt; git &lt;span class="nb"&gt;read&lt;/span&gt;-tree --prefix&lt;span class="o"&gt;=&lt;/span&gt;drupal/ -u upstream/8.0.x
&lt;span class="gp"&gt;$&lt;/span&gt; git commit
&lt;span class="go"&gt;[master bd410e7] Merge remote-tracking branch &amp;#39;upstream/8.0.x&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The upstream branch will now be a subdirectory of the master branch.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; tree -L 2
&lt;span class="go"&gt;.&lt;/span&gt;
&lt;span class="go"&gt;|-- drupal&lt;/span&gt;
&lt;span class="go"&gt;|   |-- composer.json&lt;/span&gt;
&lt;span class="go"&gt;|   |-- core&lt;/span&gt;
&lt;span class="go"&gt;|   |-- example.gitignore&lt;/span&gt;
&lt;span class="go"&gt;|   |-- index.php&lt;/span&gt;
&lt;span class="go"&gt;|   |-- modules&lt;/span&gt;
&lt;span class="go"&gt;|   |-- profiles&lt;/span&gt;
&lt;span class="go"&gt;|   |-- README.txt&lt;/span&gt;
&lt;span class="go"&gt;|   |-- robots.txt&lt;/span&gt;
&lt;span class="go"&gt;|   |-- sites&lt;/span&gt;
&lt;span class="go"&gt;|   |-- themes&lt;/span&gt;
&lt;span class="go"&gt;|   `-- web.config&lt;/span&gt;
&lt;span class="go"&gt;`-- README.md&lt;/span&gt;

&lt;span class="go"&gt;6 directories, 7 files&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="create-a-gitingore-for-drupal-core"&gt;Create a .gitingore for Drupal core&lt;/h2&gt;
&lt;p&gt;Drupal core has an example .gitignore file which provides an excellent starting
point and is sufficient for most projects.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;cp drupal/example.gitignore drupal/.gitignore
&lt;span class="nv"&gt;$ &lt;/span&gt;git add drupal/.gitignore
&lt;span class="nv"&gt;$ &lt;/span&gt;git commit -m &lt;span class="s2"&gt;&amp;quot;Add .gitignore for Drupal core&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="create-directories-above-the-document-root"&gt;Create directories above the document root&lt;/h2&gt;
&lt;p&gt;As the document root is now below the repository root, files and and
directories may be commited to the repository without exposing them to the web
server.&lt;/p&gt;
&lt;p&gt;In this example — when configuring the web server — the document root will be
set to &lt;code&gt;/var/www/myproject/drupal&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; mkdir -p config/active config/staging config/deploy
&lt;span class="gp"&gt;$&lt;/span&gt; tree -L 2
&lt;span class="go"&gt;.&lt;/span&gt;
&lt;span class="go"&gt;|-- config&lt;/span&gt;
&lt;span class="go"&gt;|   |-- active&lt;/span&gt;
&lt;span class="go"&gt;|   |-- deploy&lt;/span&gt;
&lt;span class="go"&gt;|   `-- staging&lt;/span&gt;
&lt;span class="go"&gt;|-- drupal&lt;/span&gt;
&lt;span class="go"&gt;|   |-- composer.json&lt;/span&gt;
&lt;span class="go"&gt;|   |-- core&lt;/span&gt;
&lt;span class="go"&gt;|   |-- example.gitignore&lt;/span&gt;
&lt;span class="go"&gt;|   |-- index.php&lt;/span&gt;
&lt;span class="go"&gt;|   |-- modules&lt;/span&gt;
&lt;span class="go"&gt;|   |-- profiles&lt;/span&gt;
&lt;span class="go"&gt;|   |-- README.txt&lt;/span&gt;
&lt;span class="go"&gt;|   |-- robots.txt&lt;/span&gt;
&lt;span class="go"&gt;|   |-- sites&lt;/span&gt;
&lt;span class="go"&gt;|   |-- themes&lt;/span&gt;
&lt;span class="go"&gt;|   `-- web.config&lt;/span&gt;
&lt;span class="go"&gt;`-- README.md&lt;/span&gt;

&lt;span class="go"&gt;9 directories, 7 files&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="create-the-files-directory-and-set-permissions"&gt;Create the files directory and set permissions&lt;/h2&gt;
&lt;p&gt;The Drupal &lt;code&gt;files&lt;/code&gt; directory must be manually created.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; mkdir drupal/sites/default/files
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;To work efficiently with drush the files in &lt;code&gt;sites/default/files&lt;/code&gt; should be
writeable both by the web server and command-line user. An alternative to
&lt;code&gt;chmod -R 777 sites/default/files&lt;/code&gt; is to use &lt;a href="https://wiki.debian.org/Permissions#Access_Control_Lists_in_Linux"&gt;Access Control Lists&lt;/a&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; &lt;span class="nv"&gt;HTTPDUSER&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt;ps aux &lt;span class="p"&gt;|&lt;/span&gt; grep -E &lt;span class="s1"&gt;&amp;#39;[a]pache|[h]ttpd|[_]www|[w]ww-data|[n]ginx&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="go"&gt;grep -v root | head -1 | cut -d\  -f1`&lt;/span&gt;
&lt;span class="gp"&gt;$&lt;/span&gt; sudo setfacl -R -m u:&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$HTTPDUSER&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;:rwX -m u:&lt;span class="sb"&gt;`&lt;/span&gt;whoami&lt;span class="sb"&gt;`&lt;/span&gt;:rwX drupal/sites/default/files
&lt;span class="gp"&gt;$&lt;/span&gt; sudo setfacl -dR -m u:&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$HTTPDUSER&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;:rwX -m u:&lt;span class="sb"&gt;`&lt;/span&gt;whoami&lt;span class="sb"&gt;`&lt;/span&gt;:rwX drupal/sites/default/files
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;code&gt;HTTPDUSER&lt;/code&gt; is usually &lt;code&gt;www-data&lt;/code&gt; on Debian-based distributions.&lt;/p&gt;
&lt;p&gt;It may be convenient to add similar ACL permissions to the &lt;code&gt;config/active&lt;/code&gt;,
&lt;code&gt;config/staging&lt;/code&gt;, and &lt;code&gt;config/deploy&lt;/code&gt; directories.&lt;/p&gt;
&lt;h2 id="create-database"&gt;Create database&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; mysql -uroot -p
&lt;span class="go"&gt;mysql&amp;gt; CREATE DATABASE db;&lt;/span&gt;
&lt;span class="go"&gt;mysql&amp;gt; CREATE USER &amp;#39;dbuser&amp;#39;@&amp;#39;localhost&amp;#39; IDENTIFIED BY &amp;#39;password&amp;#39;;&lt;/span&gt;
&lt;span class="go"&gt;mysql&amp;gt; GRANT ALL PRIVILEGES ON db.* TO &amp;#39;dbuser&amp;#39;@&amp;#39;localhost&amp;#39;;&lt;/span&gt;
&lt;span class="go"&gt;mysql&amp;gt; FLUSH PRIVILEGES;&lt;/span&gt;
&lt;span class="go"&gt;mysql&amp;gt; \q&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="site-installation"&gt;Site installation&lt;/h2&gt;
&lt;p&gt;Install the site with the standard install profile and change the admin
password.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; &lt;span class="nb"&gt;cd &lt;/span&gt;drupal
&lt;span class="gp"&gt;$&lt;/span&gt; drush site-install standard --db-url&lt;span class="o"&gt;=&lt;/span&gt;mysql://dbuser:password@localhost/db &lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="go"&gt;--site-name=drupal8&lt;/span&gt;
&lt;span class="gp"&gt;$&lt;/span&gt; drush upwd admin --password&lt;span class="o"&gt;=&lt;/span&gt;password
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="drupal-configuration-directories"&gt;Drupal configuration directories&lt;/h2&gt;
&lt;p&gt;Edit &lt;code&gt;sites/default/settings.php&lt;/code&gt; and update the location of the configuration
directories.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="cp"&gt;&amp;lt;?php&lt;/span&gt;

&lt;span class="c1"&gt;// Default config directories provided by the installer.&lt;/span&gt;
&lt;span class="nv"&gt;$config_directories&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;active&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;../config/active&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="nv"&gt;$config_directories&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;staging&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;../config/staging&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="c1"&gt;// Config directory used for deployments.&lt;/span&gt;
&lt;span class="nv"&gt;$config_directories&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;deploy&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;../config/deploy&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="export-configuration"&gt;Export configuration&lt;/h2&gt;
&lt;p&gt;Export the configuration from the database into the &lt;code&gt;deploy&lt;/code&gt; configuration 
directory.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; &lt;span class="nb"&gt;cd &lt;/span&gt;drupal/
&lt;span class="gp"&gt;$&lt;/span&gt; drush config-export deploy
&lt;span class="go"&gt;Configuration successfully exported to ../config/deploy.             [success]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Once exported, this configuration may be committed to the Git repository. As
part of the deployment process the configuration may be imported with the
command &lt;code&gt;drush config-import deploy&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id="update-drupal-core"&gt;Update Drupal core&lt;/h2&gt;
&lt;p&gt;To merge upstream change to Drupal core the &lt;a href="http://git-scm.com/book/en/v1/Git-Tools-Subtree-Merging"&gt;Git subtree merge strategy&lt;/a&gt; is
used.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; git pull -s subtree upstream 8.0.x
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The above command will merge the history of &lt;code&gt;upstream&lt;/code&gt; with the main
repository. If it is not preferable to merge histories the &lt;code&gt;--squash&lt;/code&gt; and
&lt;code&gt;--no-commit&lt;/code&gt; options can be used along with the &lt;code&gt;-s subtree&lt;/code&gt; strategy option:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; git checkout master
&lt;span class="gp"&gt;$&lt;/span&gt; git merge --squash -s subtree --no-commit upstream
&lt;span class="go"&gt;Squash commit -- not updating HEAD&lt;/span&gt;
&lt;span class="go"&gt;Automatic merge went well; stopped before committing as requested&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Remember to rebuild the cache after each merge:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; drush cache-rebuild
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="further-reading"&gt;Further reading&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://git-scm.com/book/en/v1/Git-Tools-Subtree-Merging"&gt;Git Tools - Subtree Merging&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.kernel.org/pub/software/scm/git/docs/howto/using-merge-subtree.html"&gt;How to use the subtree merge strategy&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://seth.fischer.nz/drupal-8-fabric-deploy.html"&gt;Deploying Drupal 8 with Fabric&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary><category term="Drupal 8"></category><category term="Drupal"></category></entry><entry><title>Getting started with Drupal 8</title><link href="http://seth.fischer.nz/drupal-8-getting-started.html" rel="alternate"></link><updated>2014-11-29T20:33:00+13:00</updated><author><name>Seth Fischer</name></author><id>tag:seth.fischer.nz,2014-11-28:drupal-8-getting-started.html</id><summary type="html">&lt;p&gt;Now that &lt;a href="https://www.drupal.org/drupal-8.0"&gt;Drupal 8&lt;/a&gt; is in beta phase it is time for site developers to start
exploring the API. This article describes the installation and configuration of
Drupal 8 using Git and Drush. Bear in mind that as of 2014-11-28 there were 22
&lt;a href="https://www.drupal.org/project/issues/search/drupal?project_issue_followers=&amp;amp;status%5B%5D=1&amp;amp;status%5B%5D=13&amp;amp;status%5B%5D=8&amp;amp;status%5B%5D=14&amp;amp;status%5B%5D=15&amp;amp;status%5B%5D=4&amp;amp;priorities%5B%5D=400&amp;amp;categories%5B%5D=1&amp;amp;categories%5B%5D=2&amp;amp;version%5B%5D=8.x&amp;amp;issue_tags_op=%3D&amp;amp;issue_tags=D8+upgrade+path"&gt;issues tagged with D8 upgrade path&lt;/a&gt;, so it may be necessary to rebuild your
site with the next core update.&lt;/p&gt;
&lt;div class="toc"&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#before-starting"&gt;Before starting&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#clone-drupal-8"&gt;Clone Drupal 8&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#create-the-files-directory-and-set-permissions"&gt;Create the files directory and set permissions&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#create-database"&gt;Create database&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#site-installation"&gt;Site installation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#configure-a-drush-alias"&gt;Configure a Drush alias&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#install-contrib-modules"&gt;Install contrib modules&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href="#devel"&gt;Devel&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#examples"&gt;Examples&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="#regularly-update-drupal-core"&gt;Regularly update Drupal core&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#further-reading"&gt;Further reading&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;h2 id="before-starting"&gt;Before starting&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;set-up a &lt;a href="https://wiki.debian.org/LaMp" title="Setting up a LAMP stack on Debian"&gt;&lt;abbr title="Linux, Apache, MySQL, PHP"&gt;LAMP&lt;/abbr&gt;&lt;/a&gt; or &lt;abbr title="Linux, nginx, MySQL, PHP"&gt;LNMP&lt;/abbr&gt; stack conforming with the
    &lt;a href="https://api.drupal.org/api/drupal/core!INSTALL.txt/8" title="Drupal 8 INSTALL.txt"&gt;Drupal 8 system requirements&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://git-scm.com/book/en/v2/Getting-Started-Installing-Git" title="Installing Git"&gt;install git&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://getcomposer.org/doc/00-intro.md#installation-nix" title="Install Composer on Unix type systems"&gt;install Composer&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;using composer, &lt;a href="https://github.com/drush-ops/drush#installupdate---composer" title="How to install Drush 7.x (dev)"&gt;install Drush 7.x (dev)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="clone-drupal-8"&gt;Clone Drupal 8&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; git clone -b 8.0.x --single-branch http://git.drupal.org/project/drupal.git
&lt;span class="gp"&gt;$&lt;/span&gt; git remote rename origin upstream
&lt;span class="gp"&gt;$&lt;/span&gt; git remote add origin &lt;span class="o"&gt;[&lt;/span&gt;url&lt;span class="o"&gt;]&lt;/span&gt;
&lt;span class="gp"&gt;$&lt;/span&gt; git checkout -b master
&lt;span class="gp"&gt;$&lt;/span&gt; cp example.gitignore .gitignore
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="create-the-files-directory-and-set-permissions"&gt;Create the files directory and set permissions&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; mkdir sites/default/files
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;To work efficiently with drush the files in &lt;code&gt;sites/default/files&lt;/code&gt; should be
writeable both by the web server and command line user. An alternative to
&lt;code&gt;chmod -R 777 sites/default/files&lt;/code&gt; is to use &lt;a href="https://wiki.debian.org/Permissions#Access_Control_Lists_in_Linux" title="Access Control Lists in Linux"&gt;Access Control Lists&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Those familiar with the Symfony 2 documentation will recognise the following
shell commands which have been adapted from the
&lt;a href="http://Symfony.com/doc/2.3/book/installation.html#configuration-and-set-up"&gt;Installing and Configuring Symfony&lt;/a&gt; chapter of the The Symfony Book.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; &lt;span class="nv"&gt;HTTPDUSER&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt;ps aux &lt;span class="p"&gt;|&lt;/span&gt; grep -E &lt;span class="s1"&gt;&amp;#39;[a]pache|[h]ttpd|[_]www|[w]ww-data|[n]ginx&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; grep -v root &lt;span class="p"&gt;|&lt;/span&gt; head -1 &lt;span class="p"&gt;|&lt;/span&gt; cut -d&lt;span class="se"&gt;\ &lt;/span&gt; -f1&lt;span class="sb"&gt;`&lt;/span&gt;
&lt;span class="gp"&gt;$&lt;/span&gt; sudo setfacl -R -m u:&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$HTTPDUSER&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;:rwX -m u:&lt;span class="sb"&gt;`&lt;/span&gt;whoami&lt;span class="sb"&gt;`&lt;/span&gt;:rwX sites/default/files
&lt;span class="gp"&gt;$&lt;/span&gt; sudo setfacl -dR -m u:&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$HTTPDUSER&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;:rwX -m u:&lt;span class="sb"&gt;`&lt;/span&gt;whoami&lt;span class="sb"&gt;`&lt;/span&gt;:rwX sites/default/files
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;code&gt;HTTPDUSER&lt;/code&gt; is usually &lt;code&gt;www-data&lt;/code&gt; on Debian-based distributions.&lt;/p&gt;
&lt;p&gt;Before setting the access control only the drush user will have &lt;code&gt;rw&lt;/code&gt; permissions:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; getfacl sites/default/files
&lt;span class="gp"&gt;#&lt;/span&gt; file: cache
&lt;span class="gp"&gt;#&lt;/span&gt; owner: drushuser
&lt;span class="gp"&gt;#&lt;/span&gt; group: drushuser
&lt;span class="go"&gt;user::rwx&lt;/span&gt;
&lt;span class="go"&gt;group::rwx&lt;/span&gt;
&lt;span class="go"&gt;other::rwx&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;After setting the access control both the web server user and drush user will
have &lt;code&gt;rw&lt;/code&gt; permissions:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; getfacl sites/default/files
&lt;span class="gp"&gt;#&lt;/span&gt; file: cache
&lt;span class="gp"&gt;#&lt;/span&gt; owner: drushuser
&lt;span class="gp"&gt;#&lt;/span&gt; group: drushuser
&lt;span class="go"&gt;user::rwx&lt;/span&gt;
&lt;span class="go"&gt;user:www-data:rwx&lt;/span&gt;
&lt;span class="go"&gt;user:drushuser:rwx&lt;/span&gt;
&lt;span class="go"&gt;group::rwx&lt;/span&gt;
&lt;span class="go"&gt;mask::rwx&lt;/span&gt;
&lt;span class="go"&gt;other::rwx&lt;/span&gt;
&lt;span class="go"&gt;default:user::rwx&lt;/span&gt;
&lt;span class="go"&gt;default:user:www-data:rwx&lt;/span&gt;
&lt;span class="go"&gt;default:user:drushuser:rwx&lt;/span&gt;
&lt;span class="go"&gt;default:group::rwx&lt;/span&gt;
&lt;span class="go"&gt;default:mask::rwx&lt;/span&gt;
&lt;span class="go"&gt;default:other::rwx&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="create-database"&gt;Create database&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; mysql -uroot -p
&lt;span class="go"&gt;mysql&amp;gt; CREATE DATABASE db;&lt;/span&gt;
&lt;span class="go"&gt;mysql&amp;gt; CREATE USER &amp;#39;dbuser&amp;#39;@&amp;#39;localhost&amp;#39; IDENTIFIED BY &amp;#39;password&amp;#39;;&lt;/span&gt;
&lt;span class="go"&gt;mysql&amp;gt; GRANT ALL PRIVILEGES ON db.* TO &amp;#39;dbuser&amp;#39;@&amp;#39;localhost&amp;#39;;&lt;/span&gt;
&lt;span class="go"&gt;mysql&amp;gt; FLUSH PRIVILEGES;&lt;/span&gt;
&lt;span class="go"&gt;mysql&amp;gt; \q&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="site-installation"&gt;Site installation&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; drush site-install standard --db-url&lt;span class="o"&gt;=&lt;/span&gt;mysql://dbuser:password@localhost/db --site-name&lt;span class="o"&gt;=&lt;/span&gt;drupal8
&lt;span class="gp"&gt;$&lt;/span&gt; drush upwd admin --password&lt;span class="o"&gt;=&lt;/span&gt;password
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Drupal 8 beta is now configured and you may login with the username "admin" and
password "password".&lt;/p&gt;
&lt;h2 id="configure-a-drush-alias"&gt;Configure a Drush alias&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; cp ~/.composer/vendor/drush/drush/examples/example.aliases.drushrc.php ~/.drush/aliases.drushrc.php
&lt;span class="gp"&gt;$&lt;/span&gt; drush site-alias @self --full --with-optional &amp;gt;&amp;gt; ~/.drush/aliases.drushrc.php
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Edit &lt;code&gt;~/.drush/aliases.drushrc.php&lt;/code&gt; and enter your site's URI.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="cp"&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class="sd"&gt;/**&lt;/span&gt;
&lt;span class="sd"&gt; * Drupal 8 beta&lt;/span&gt;
&lt;span class="sd"&gt; */&lt;/span&gt;
&lt;span class="nv"&gt;$aliases&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;drupal8&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;array&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
  &lt;span class="s1"&gt;&amp;#39;root&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;/var/www/drupal8&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="s1"&gt;&amp;#39;uri&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;http://drupal8&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="s1"&gt;&amp;#39;#name&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;drupal8&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="s1"&gt;&amp;#39;path-aliases&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; 
  &lt;span class="k"&gt;array&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="s1"&gt;&amp;#39;%drush&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;/home/seth/.composer/vendor/drush/drush&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="s1"&gt;&amp;#39;%site&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;sites/default/&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="p"&gt;),&lt;/span&gt;
&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Check that your system meets the minimum core requirements:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; drush @drupal8 core-requirements
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Check the status of the site installation by running &lt;code&gt;drush @drupal8 status&lt;/code&gt;.
The output will be similar to the following:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; drush @drupal8 status
&lt;span class="go"&gt; Drupal version         :  8.0.0-dev&lt;/span&gt;
&lt;span class="go"&gt; Site URI               :  http://drupal8&lt;/span&gt;
&lt;span class="go"&gt; Database driver        :  mysql&lt;/span&gt;
&lt;span class="go"&gt; Database hostname      :  localhost&lt;/span&gt;
&lt;span class="go"&gt; Database port          :&lt;/span&gt;
&lt;span class="go"&gt; Database username      :  drupal8&lt;/span&gt;
&lt;span class="go"&gt; Database name          :  drupal8&lt;/span&gt;
&lt;span class="go"&gt; Database               :  Connected&lt;/span&gt;
&lt;span class="go"&gt; Drupal bootstrap       :  Successful&lt;/span&gt;
&lt;span class="go"&gt; Drupal user            :  Anonymous&lt;/span&gt;
&lt;span class="go"&gt; Default theme          :  bartik&lt;/span&gt;
&lt;span class="go"&gt; Administration theme   :  seven&lt;/span&gt;
&lt;span class="go"&gt; PHP executable         :  /usr/bin/php&lt;/span&gt;
&lt;span class="go"&gt; PHP configuration      :  /etc/php5/cli/php.ini&lt;/span&gt;
&lt;span class="go"&gt; PHP OS                 :  Linux&lt;/span&gt;
&lt;span class="go"&gt; Drush version          :  7.0-dev&lt;/span&gt;
&lt;span class="go"&gt; Drush temp directory   :  /tmp&lt;/span&gt;
&lt;span class="go"&gt; Drush configuration    :&lt;/span&gt;
&lt;span class="go"&gt; Drush alias files      :  /home/user/.drush/aliases.drushrc.php&lt;/span&gt;
&lt;span class="go"&gt; Drupal root            :  /var/www/drupal8&lt;/span&gt;
&lt;span class="go"&gt; Site path              :  sites/default&lt;/span&gt;
&lt;span class="go"&gt; File directory path    :  sites/default/files&lt;/span&gt;
&lt;span class="go"&gt; Temporary file         :  /tmp&lt;/span&gt;
&lt;span class="go"&gt; directory path&lt;/span&gt;
&lt;span class="go"&gt; Active config path     :  sites/default/files/config_jP-uX_4rcMWllW18FM124krsM&lt;/span&gt;
&lt;span class="go"&gt;                           An44d1rdD2t5zXZLAaQcrXQjUATnoTTQ5gtw-iH5fqcmlTFCQ/ac&lt;/span&gt;
&lt;span class="go"&gt;                           tive&lt;/span&gt;
&lt;span class="go"&gt; Staging config path    :  sites/default/files/config_jP-uX_4rcMWllW18FM124krsM&lt;/span&gt;
&lt;span class="go"&gt;                           An44d1rdD2t5zXZLAaQcrXQjUATnoTTQ5gtw-iH5fqcmlTFCQ/st&lt;/span&gt;
&lt;span class="go"&gt;                           aging&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="install-contrib-modules"&gt;Install contrib modules&lt;/h2&gt;
&lt;p&gt;Two useful modules for developers are &lt;a href="https://www.drupal.org/project/devel"&gt;devel&lt;/a&gt; and &lt;a href="https://www.drupal.org/project/examples"&gt;examples&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id="devel"&gt;Devel&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; drush @drupal8 pm-download devel
&lt;span class="gp"&gt;$&lt;/span&gt; drush @drupal8 pm-enable devel
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="examples"&gt;Examples&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; drush @drupal8 pm-download examples
&lt;span class="gp"&gt;$&lt;/span&gt; drush @drupal8 pm-enable examples
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The single command &lt;code&gt;drush @drupal8 pm-enable module&lt;/code&gt; will download module (if
required) before enabling it.&lt;/p&gt;
&lt;h2 id="regularly-update-drupal-core"&gt;Regularly update Drupal core&lt;/h2&gt;
&lt;p&gt;As Drupal 8 pushes on through beta releases you should regularly merge in the
latest code:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;(master)$&lt;/span&gt; git checkout master
&lt;span class="gp"&gt;(master)$&lt;/span&gt; git fetch upstream
&lt;span class="gp"&gt;(master)$&lt;/span&gt; git merge upstream/8.0.x
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Remember to rebuild the site after each merge:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="gp"&gt;$&lt;/span&gt; drush cache-rebuild
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Before all issues tagged with "D8 upgrade path" have been closed you may find
that you are required to repeat the site installation commands as described
above after updating Drupal core.&lt;/p&gt;
&lt;h2 id="further-reading"&gt;Further reading&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.drupal.org/node/803746"&gt;Building a Drupal site with Git&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://gitref.org/"&gt;Git Reference&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary><category term="Drupal 8"></category><category term="Drupal"></category></entry></feed>