<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <title>A Drupal 8 workflow using the Git subtree merge strategy</title>
        <link rel="stylesheet" href="http://seth.fischer.nz/theme/css/main.css" />
        <link href="http://seth.fischer.nz/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="sethfischer Atom Feed" />
        <meta name="description" content="Often there are components of a Drupal website that should not be located in the document root such as configuration files. It is convenient to..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://seth.fischer.nz/">sethfischer</a></h1>
                <nav><ul>
                    <li><a href="http://seth.fischer.nz/about.html">About</a></li>
                    <li class="active"><a href="http://seth.fischer.nz/category/drupal.html">Drupal</a></li>
                    <li><a href="http://seth.fischer.nz/category/misc.html">Misc</a></li>
                    <li><a href="http://seth.fischer.nz/category/symfony.html">Symfony</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="http://seth.fischer.nz/drupal-8-workflow-using-git-subtree-merging.html" rel="bookmark"
           title="Permalink to A Drupal 8 workflow using the Git subtree merge strategy">A Drupal 8 workflow using the Git subtree merge strategy</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-01-23T19:20:00+13:00">
                Published: 23 January 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://seth.fischer.nz/author/seth-fischer.html">Seth Fischer</a>
        </address>
<p>In <a href="http://seth.fischer.nz/category/drupal.html">Drupal</a>.</p>
<p>tags: <a href="http://seth.fischer.nz/tag/drupal-8.html">Drupal 8</a> <a href="http://seth.fischer.nz/tag/drupal.html">Drupal</a> </p>
</footer><!-- /.post-info -->      <p class="alert alert-danger" role="alert">Due to the non-linear development of Drupal&nbsp;8 the subtree merge strategy
described in this article is not viable. Consider using the
<a href="https://github.com/drupal-composer/drupal-project">Composer template for Drupal projects</a>.</p>
<p>Often there are components of a Drupal website that should not be located in
the document root such as configuration files, deployment scripts, and
functional tests. By utilising Git subtrees, a Drupal installation root (or web
server document root) may be below the root of the main repository, and
upstream changes to Drupal core may be conveniently merged with
<code>git read-tree</code>.</p>
<div class="toc">
<ul>
<li><a href="#initialise-git-repository">Initialise Git repository</a></li>
<li><a href="#add-upstream-remote">Add upstream remote</a></li>
<li><a href="#checkout-a-local-copy-of-the-upstream-branch">Checkout a local copy of the upstream branch</a></li>
<li><a href="#pull-upstream-into-a-subdirectory-in-the-master-branch">Pull upstream into a subdirectory in the master branch</a></li>
<li><a href="#create-a-gitingore-for-drupal-core">Create a .gitingore for Drupal core</a></li>
<li><a href="#create-directories-above-the-document-root">Create directories above the document root</a></li>
<li><a href="#create-the-files-directory-and-set-permissions">Create the files directory and set permissions</a></li>
<li><a href="#create-database">Create database</a></li>
<li><a href="#site-installation">Site installation</a></li>
<li><a href="#drupal-configuration-directories">Drupal configuration directories</a></li>
<li><a href="#export-configuration">Export configuration</a></li>
<li><a href="#update-drupal-core">Update Drupal core</a></li>
<li><a href="#further-reading">Further reading</a></li>
</ul>
</div>
<h2 id="initialise-git-repository">Initialise Git repository</h2>
<p>Initialise Git repository and add your <code>.gitignore</code>, <code>README</code>, and <code>LICENSE</code>
files.</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> mkdir myproject
<span class="gp">$</span> <span class="nb">cd</span> myproject
<span class="gp">$</span> git init
<span class="go">Initialized empty Git repository in /var/www/myproject/.git/</span>
<span class="gp">$</span> vi README.md
<span class="gp">$</span> git add README.md
<span class="gp">$</span> git commit -m <span class="s2">&quot;Add README.md&quot;</span>
<span class="go">[master (root-commit) 3a30763] Add README.txt</span>
<span class="go"> 1 file changed, 1 insertion(+)</span>
<span class="go"> create mode 100644 README.txt</span>
</code></pre></div>


<h2 id="add-upstream-remote">Add upstream remote</h2>
<p>Add the drupal.org git repository as a remote with the name <code>upstream</code>. To
improve efficiency specify that only the <code>8.0.x</code> branch is to be tracked with
the <code>-t</code> option.</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> git remote add -t <span class="m">8</span>.0.x upstream http://git.drupal.org/project/drupal.git
<span class="gp">$</span> git fetch upstream
</code></pre></div>


<h2 id="checkout-a-local-copy-of-the-upstream-branch">Checkout a local copy of the upstream branch</h2>
<p>Checkout a local copy of the <code>upstream/8.0.x</code> branch.</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> git checkout -b upstream upstream/8.0.x
<span class="go">Branch upstream set up to track remote branch 8.0.x from upstream by rebasing.</span>
<span class="go">Switched to a new branch &#39;upstream&#39;</span>
</code></pre></div>


<h2 id="pull-upstream-into-a-subdirectory-in-the-master-branch">Pull upstream into a subdirectory in the master branch</h2>
<p>The <code>upstream/8.0.x</code> branch is pulled in as a subdirectory of the master
branch using the <code>git read-tree</code> command. The name of the subdirectory is
specified with the <code>--prefix</code> option; in this case <code>drupal/</code>.</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge -s ours --no-commit upstream/8.0.x
<span class="go">Automatic merge went well; stopped before committing as requested</span>
<span class="gp">$</span> git read-tree --prefix<span class="o">=</span>drupal/ -u upstream/8.0.x
<span class="gp">$</span> git commit
<span class="go">[master bd410e7] Merge remote-tracking branch &#39;upstream/8.0.x&#39;</span>
</code></pre></div>


<p>The upstream branch will now be a subdirectory of the master branch.</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> tree -L <span class="m">2</span>
<span class="go">.</span>
<span class="go">|-- drupal</span>
<span class="go">|   |-- composer.json</span>
<span class="go">|   |-- core</span>
<span class="go">|   |-- example.gitignore</span>
<span class="go">|   |-- index.php</span>
<span class="go">|   |-- modules</span>
<span class="go">|   |-- profiles</span>
<span class="go">|   |-- README.txt</span>
<span class="go">|   |-- robots.txt</span>
<span class="go">|   |-- sites</span>
<span class="go">|   |-- themes</span>
<span class="go">|   `-- web.config</span>
<span class="go">`-- README.md</span>

<span class="go">6 directories, 7 files</span>
</code></pre></div>


<h2 id="create-a-gitingore-for-drupal-core">Create a .gitingore for Drupal core</h2>
<p>Drupal core has an example .gitignore file which provides an excellent starting
point and is sufficient for most projects.</p>
<div class="highlight"><pre><span></span><code>$ cp drupal/example.gitignore drupal/.gitignore
$ git add drupal/.gitignore
$ git commit -m <span class="s2">&quot;Add .gitignore for Drupal core&quot;</span>
</code></pre></div>


<h2 id="create-directories-above-the-document-root">Create directories above the document root</h2>
<p>As the document root is now below the repository root, files and and
directories may be commited to the repository without exposing them to the web
server.</p>
<p>In this example — when configuring the web server — the document root will be
set to <code>/var/www/myproject/drupal</code>.</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> mkdir -p config/active config/staging config/deploy
<span class="gp">$</span> tree -L <span class="m">2</span>
<span class="go">.</span>
<span class="go">|-- config</span>
<span class="go">|   |-- active</span>
<span class="go">|   |-- deploy</span>
<span class="go">|   `-- staging</span>
<span class="go">|-- drupal</span>
<span class="go">|   |-- composer.json</span>
<span class="go">|   |-- core</span>
<span class="go">|   |-- example.gitignore</span>
<span class="go">|   |-- index.php</span>
<span class="go">|   |-- modules</span>
<span class="go">|   |-- profiles</span>
<span class="go">|   |-- README.txt</span>
<span class="go">|   |-- robots.txt</span>
<span class="go">|   |-- sites</span>
<span class="go">|   |-- themes</span>
<span class="go">|   `-- web.config</span>
<span class="go">`-- README.md</span>

<span class="go">9 directories, 7 files</span>
</code></pre></div>


<h2 id="create-the-files-directory-and-set-permissions">Create the files directory and set permissions</h2>
<p>The Drupal <code>files</code> directory must be manually created.</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> mkdir drupal/sites/default/files
</code></pre></div>


<p>To work efficiently with drush the files in <code>sites/default/files</code> should be
writeable both by the web server and command-line user. An alternative to
<code>chmod -R 777 sites/default/files</code> is to use <a href="https://wiki.debian.org/Permissions#Access_Control_Lists_in_Linux">Access Control Lists</a>.</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> <span class="nv">HTTPDUSER</span><span class="o">=</span><span class="sb">`</span>ps aux <span class="p">|</span> grep -E <span class="s1">&#39;[a]pache|[h]ttpd|[_]www|[w]ww-data|[n]ginx&#39;</span> <span class="p">|</span> <span class="se">\</span>
grep -v root <span class="p">|</span> head -1 <span class="p">|</span> cut -d<span class="se">\ </span> -f1<span class="sb">`</span>
<span class="gp">$</span> sudo setfacl -R -m u:<span class="s2">&quot;</span><span class="nv">$HTTPDUSER</span><span class="s2">&quot;</span>:rwX -m u:<span class="sb">`</span>whoami<span class="sb">`</span>:rwX drupal/sites/default/files
<span class="gp">$</span> sudo setfacl -dR -m u:<span class="s2">&quot;</span><span class="nv">$HTTPDUSER</span><span class="s2">&quot;</span>:rwX -m u:<span class="sb">`</span>whoami<span class="sb">`</span>:rwX drupal/sites/default/files
</code></pre></div>


<p><code>HTTPDUSER</code> is usually <code>www-data</code> on Debian-based distributions.</p>
<p>It may be convenient to add similar ACL permissions to the <code>config/active</code>,
<code>config/staging</code>, and <code>config/deploy</code> directories.</p>
<h2 id="create-database">Create database</h2>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> mysql -uroot -p
<span class="go">mysql&gt; CREATE DATABASE db;</span>
<span class="go">mysql&gt; CREATE USER &#39;dbuser&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;password&#39;;</span>
<span class="go">mysql&gt; GRANT ALL PRIVILEGES ON db.* TO &#39;dbuser&#39;@&#39;localhost&#39;;</span>
<span class="go">mysql&gt; FLUSH PRIVILEGES;</span>
<span class="go">mysql&gt; \q</span>
</code></pre></div>


<h2 id="site-installation">Site installation</h2>
<p>Install the site with the standard install profile and change the admin
password.</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> <span class="nb">cd</span> drupal
<span class="gp">$</span> drush site-install standard --db-url<span class="o">=</span>mysql://dbuser:password@localhost/db <span class="se">\</span>
--site-name<span class="o">=</span>drupal8
<span class="gp">$</span> drush upwd admin --password<span class="o">=</span>password
</code></pre></div>


<h2 id="drupal-configuration-directories">Drupal configuration directories</h2>
<p>Edit <code>sites/default/settings.php</code> and update the location of the configuration
directories.</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="c1">// Default config directories provided by the installer.</span>
<span class="nv">$config_directories</span><span class="p">[</span><span class="s1">&#39;active&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;../config/active&#39;</span><span class="p">;</span>
<span class="nv">$config_directories</span><span class="p">[</span><span class="s1">&#39;staging&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;../config/staging&#39;</span><span class="p">;</span>

<span class="c1">// Config directory used for deployments.</span>
<span class="nv">$config_directories</span><span class="p">[</span><span class="s1">&#39;deploy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;../config/deploy&#39;</span><span class="p">;</span>
</code></pre></div>


<h2 id="export-configuration">Export configuration</h2>
<p>Export the configuration from the database into the <code>deploy</code> configuration 
directory.</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> <span class="nb">cd</span> drupal/
<span class="gp">$</span> drush config-export deploy
<span class="go">Configuration successfully exported to ../config/deploy.             [success]</span>
</code></pre></div>


<p>Once exported, this configuration may be committed to the Git repository. As
part of the deployment process the configuration may be imported with the
command <code>drush config-import deploy</code>.</p>
<h2 id="update-drupal-core">Update Drupal core</h2>
<p>To merge upstream change to Drupal core the <a href="http://git-scm.com/book/en/v1/Git-Tools-Subtree-Merging">Git subtree merge strategy</a> is
used.</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> git pull -s subtree upstream <span class="m">8</span>.0.x
</code></pre></div>


<p>The above command will merge the history of <code>upstream</code> with the main
repository. If it is not preferable to merge histories the <code>--squash</code> and
<code>--no-commit</code> options can be used along with the <code>-s subtree</code> strategy option:</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge --squash -s subtree --no-commit upstream
<span class="go">Squash commit -- not updating HEAD</span>
<span class="go">Automatic merge went well; stopped before committing as requested</span>
</code></pre></div>


<p>Remember to rebuild the cache after each merge:</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span> drush cache-rebuild
</code></pre></div>


<h2 id="further-reading">Further reading</h2>
<ul>
<li><a href="http://git-scm.com/book/en/v1/Git-Tools-Subtree-Merging">Git Tools - Subtree Merging</a></li>
<li><a href="https://www.kernel.org/pub/software/scm/git/docs/howto/using-merge-subtree.html">How to use the subtree merge strategy</a></li>
<li><a href="http://seth.fischer.nz/drupal-8-fabric-deploy.html">Deploying Drupal 8 with Fabric</a></li>
</ul>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://leaf-obd.readthedocs.io/">Nissan Leaf OBD-II manual</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://seth.fischer.nz/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://github.com/sethfischer">GitHub</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>